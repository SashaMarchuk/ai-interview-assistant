---
phase: 19-file-personalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/services/fileStorage/fileStorageDB.ts
  - src/services/fileStorage/pdfExtractor.ts
  - src/services/fileStorage/index.ts
autonomous: true

must_haves:
  truths:
    - "IndexedDB database 'file-personalization' can store and retrieve resume and jobDescription records"
    - "PDF files can be loaded and their text content extracted client-side without a server"
    - "TXT files can be read and their text content returned as a string"
  artifacts:
    - path: "src/services/fileStorage/fileStorageDB.ts"
      provides: "IndexedDB CRUD operations for file records"
      exports: ["saveFileContent", "getFileContent", "deleteFileContent", "FileRecord"]
    - path: "src/services/fileStorage/pdfExtractor.ts"
      provides: "Client-side PDF text extraction"
      exports: ["extractTextFromPDF"]
    - path: "src/services/fileStorage/index.ts"
      provides: "Barrel export for fileStorage module"
  key_links:
    - from: "src/services/fileStorage/fileStorageDB.ts"
      to: "idb"
      via: "openDB import"
      pattern: "import.*from 'idb'"
    - from: "src/services/fileStorage/pdfExtractor.ts"
      to: "pdfjs-dist"
      via: "getDocument import"
      pattern: "import.*from 'pdfjs-dist'"
---

<objective>
Install pdfjs-dist and idb dependencies, then create the file storage and PDF extraction service layer for Phase 19 (File Personalization).

Purpose: Establish the data layer that the UI (Plan 02) will use to save/load resume and job description content, and extract text from uploaded PDF files. This plan creates reusable services with no UI coupling.

Output: Two new service files (fileStorageDB.ts, pdfExtractor.ts) with barrel export, plus updated package.json with new dependencies.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-file-personalization/19-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create IndexedDB file storage service</name>
  <files>
    package.json
    src/services/fileStorage/fileStorageDB.ts
    src/services/fileStorage/index.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install pdfjs-dist idb
   ```

2. Create `src/services/fileStorage/fileStorageDB.ts`:
   - Define `FileRecord` interface: `{ type: 'resume' | 'jobDescription'; text: string; fileName?: string; updatedAt: number }`
   - Define `FilePersonalizationDB` typed schema for idb: store name `'files'`, keyPath `'type'`
   - Use lazy singleton pattern for DB connection (`let dbPromise: Promise<IDBPDatabase<FilePersonalizationDB>> | null = null`)
   - `getDB()` function: opens DB `'file-personalization'` version 1, creates `'files'` object store in upgrade callback
   - `saveFileContent(record: FileRecord): Promise<void>` -- uses `db.put('files', record)`
   - `getFileContent(type: 'resume' | 'jobDescription'): Promise<FileRecord | undefined>` -- uses `db.get('files', type)`
   - `deleteFileContent(type: 'resume' | 'jobDescription'): Promise<void>` -- uses `db.delete('files', type)`
   - Export all three functions and the `FileRecord` type
   - Import `openDB` and `type IDBPDatabase` from `'idb'`

3. Create `src/services/fileStorage/index.ts`:
   - Barrel export: re-export `saveFileContent`, `getFileContent`, `deleteFileContent`, `type FileRecord` from `./fileStorageDB`
   - Re-export `extractTextFromPDF` from `./pdfExtractor` (will be created in Task 2)
  </action>
  <verify>
    - `npx tsc --noEmit` passes (types are correct)
    - `src/services/fileStorage/fileStorageDB.ts` exists and exports the three functions + FileRecord type
    - `src/services/fileStorage/index.ts` exists and re-exports everything
    - `package.json` includes `pdfjs-dist` and `idb` in dependencies
  </verify>
  <done>IndexedDB storage service exists with typed CRUD operations for resume and jobDescription file records, using idb Promise wrapper. Both libraries installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create PDF text extraction service</name>
  <files>
    src/services/fileStorage/pdfExtractor.ts
  </files>
  <action>
1. Create `src/services/fileStorage/pdfExtractor.ts`:
   - Import `* as pdfjsLib` from `'pdfjs-dist'`
   - Import worker URL using Vite's `?url` suffix: `import pdfjsWorker from 'pdfjs-dist/build/pdf.worker.mjs?url'`
     - If TypeScript complains about the `?url` import, add a module declaration in a `.d.ts` file or use `// @ts-expect-error` with comment explaining Vite handles this at build time
   - Set `pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsWorker` at module level
   - Export `async function extractTextFromPDF(file: File): Promise<string>`:
     - Read file as ArrayBuffer: `const arrayBuffer = await file.arrayBuffer()`
     - Convert to Uint8Array: `const typedArray = new Uint8Array(arrayBuffer)`
     - Load PDF: `const pdf = await pdfjsLib.getDocument(typedArray).promise`
     - Loop through pages (1 to pdf.numPages):
       - `const page = await pdf.getPage(i)`
       - `const textContent = await page.getTextContent()`
       - Extract text: `textContent.items.map(item => ('str' in item ? item.str : '')).join(' ')`
       - Collect page text into array
     - Join all pages with `'\n\n'` separator
     - Return the joined text string

2. Handle the `?url` import TypeScript issue:
   - Check if `src/vite-env.d.ts` or similar exists. If so, add module declaration there.
   - If not, create a minimal type declaration: `declare module 'pdfjs-dist/build/pdf.worker.mjs?url' { const url: string; export default url; }`
   - Place it where TypeScript will pick it up (e.g., `src/types/pdfjs-worker.d.ts` or in existing env.d.ts)
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no type errors from pdfjs-dist imports or ?url import)
    - `src/services/fileStorage/pdfExtractor.ts` exists and exports `extractTextFromPDF`
    - The barrel export in `index.ts` (from Task 1) correctly re-exports `extractTextFromPDF`
    - `npx eslint src/services/fileStorage/` passes
  </verify>
  <done>PDF text extraction service exists, configured with Vite-compatible worker loading via ?url import. TypeScript compiles without errors. extractTextFromPDF accepts a File and returns extracted text as a string.</done>
</task>

</tasks>

<verification>
- `npm run dev` or `npx tsc --noEmit` -- no TypeScript errors
- `npx eslint src/services/fileStorage/` -- no lint errors
- All three files exist: `fileStorageDB.ts`, `pdfExtractor.ts`, `index.ts`
- `package.json` has `pdfjs-dist` and `idb` in dependencies
- Barrel export re-exports all public symbols
</verification>

<success_criteria>
- pdfjs-dist and idb are installed as dependencies
- IndexedDB file storage service provides typed CRUD for resume and jobDescription records
- PDF extraction service can convert a File object to extracted text string
- All code compiles with strict TypeScript and passes ESLint
</success_criteria>

<output>
After completion, create `.planning/phases/19-file-personalization/19-01-SUMMARY.md`
</output>
