---
phase: 19-file-personalization
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/components/settings/FileUploadSettings.tsx
  - entrypoints/popup/App.tsx
  - src/services/llm/PromptBuilder.ts
  - entrypoints/background.ts
autonomous: true

must_haves:
  truths:
    - "User can upload a PDF or TXT resume file via a file picker in popup settings and see a preview of extracted text"
    - "User can paste or upload a job description via popup settings"
    - "Uploaded file content persists in IndexedDB across browser restarts"
    - "LLM responses are personalized based on uploaded resume and job description content"
    - "User can delete uploaded resume or job description"
    - "Scanned/image PDFs show a warning when little text is extracted"
  artifacts:
    - path: "src/components/settings/FileUploadSettings.tsx"
      provides: "File upload and paste UI for resume and job description"
      exports: ["FileUploadSettings"]
    - path: "src/services/llm/PromptBuilder.ts"
      provides: "Prompt building with optional file context injection"
      exports: ["buildPrompt", "BuildPromptResult"]
    - path: "entrypoints/popup/App.tsx"
      provides: "Popup settings tab with FileUploadSettings section"
    - path: "entrypoints/background.ts"
      provides: "Background reads file context from IndexedDB before building prompts"
  key_links:
    - from: "src/components/settings/FileUploadSettings.tsx"
      to: "src/services/fileStorage/fileStorageDB.ts"
      via: "saveFileContent, getFileContent, deleteFileContent imports"
      pattern: "import.*from.*fileStorage"
    - from: "src/components/settings/FileUploadSettings.tsx"
      to: "src/services/fileStorage/pdfExtractor.ts"
      via: "extractTextFromPDF import"
      pattern: "extractTextFromPDF"
    - from: "entrypoints/background.ts"
      to: "src/services/fileStorage/fileStorageDB.ts"
      via: "getFileContent import for IndexedDB read"
      pattern: "getFileContent"
    - from: "entrypoints/background.ts"
      to: "src/services/llm/PromptBuilder.ts"
      via: "buildPrompt call with fileContext parameter"
      pattern: "buildPrompt.*fileContext"
    - from: "src/services/llm/PromptBuilder.ts"
      to: "system prompt"
      via: "appended file context sections"
      pattern: "Candidate Background|Target Role"
---

<objective>
Create the file upload UI component, integrate it into popup settings, and wire the prompt injection pipeline so uploaded resume and job description content is automatically injected into LLM system prompts.

Purpose: Complete the file personalization feature end-to-end -- from user uploading files in the popup, through storage in IndexedDB, to the background service worker reading that content and injecting it into every LLM request via PromptBuilder.

Output: FileUploadSettings component in popup, modified PromptBuilder with file context support, background.ts reading IndexedDB before prompt building.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-file-personalization/19-RESEARCH.md
@.planning/phases/19-file-personalization/19-01-SUMMARY.md
@src/services/llm/PromptBuilder.ts
@entrypoints/background.ts
@entrypoints/popup/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FileUploadSettings component and add to popup</name>
  <files>
    src/components/settings/FileUploadSettings.tsx
    entrypoints/popup/App.tsx
  </files>
  <action>
1. Create `src/components/settings/FileUploadSettings.tsx`:
   - Import `useState`, `useEffect` from React
   - Import `saveFileContent`, `getFileContent`, `deleteFileContent` from `../../services/fileStorage`
   - Import `extractTextFromPDF` from `../../services/fileStorage`
   - Import `type FileRecord` from `../../services/fileStorage`

   **State:**
   - `resumeStatus: string` -- displays file name + char count or warning
   - `resumePreview: string` -- first ~200 chars of extracted resume text for preview
   - `jdText: string` -- textarea content for job description
   - `jdSaved: boolean` -- flag to show "Saved" confirmation briefly
   - `isExtracting: boolean` -- loading state during PDF extraction
   - `hasResume: boolean` -- whether a resume record exists (for showing delete button)
   - `hasJD: boolean` -- whether a JD record exists

   **On mount (useEffect):**
   - Load existing resume record: `getFileContent('resume')`. If exists, set `resumeStatus` to `"fileName (N chars)"`, set `resumePreview` to first 200 chars, set `hasResume = true`
   - Load existing JD record: `getFileContent('jobDescription')`. If exists, set `jdText` to its text, set `hasJD = true`

   **handleResumeUpload(event: React.ChangeEvent<HTMLInputElement>):**
   - Get file from `event.target.files?.[0]`, return if none
   - Set `isExtracting = true`
   - If file.name ends with `.pdf`: call `extractTextFromPDF(file)` to get text
   - Else (TXT): call `file.text()` to get text
   - If extracted text trimmed length < 50: set `resumeStatus` to warning message "Very little text extracted. This may be a scanned PDF. Try a text-based PDF or paste resume content directly.", set `isExtracting = false`, return
   - Truncate text to 8,000 characters
   - Save to IndexedDB: `saveFileContent({ type: 'resume', text: truncatedText, fileName: file.name, updatedAt: Date.now() })`
   - Update state: `resumeStatus` = `"fileName (N chars)"`, `resumePreview` = first 200 chars, `hasResume = true`
   - Set `isExtracting = false`
   - Wrap in try/catch: on error, set `resumeStatus` = "Error extracting text from file"

   **handleResumeDelete():**
   - Call `deleteFileContent('resume')`
   - Reset state: `resumeStatus = ''`, `resumePreview = ''`, `hasResume = false`
   - Reset the file input value (use a ref on the input element and set `ref.current.value = ''`)

   **handleJdSave():**
   - If `jdText.trim()` is empty: call `deleteFileContent('jobDescription')`, set `hasJD = false`, return
   - Truncate to 4,000 characters
   - Save: `saveFileContent({ type: 'jobDescription', text: truncatedJd, updatedAt: Date.now() })`
   - Set `hasJD = true`, `jdSaved = true`
   - After 2 seconds, set `jdSaved = false` (brief confirmation)

   **handleJdDelete():**
   - Call `deleteFileContent('jobDescription')`
   - Reset: `jdText = ''`, `hasJD = false`

   **Render:**
   - Wrap in a `<div className="space-y-4">`

   **Resume section:**
   - Label: "Resume" with accepted formats note "(PDF, TXT)"
   - File input: `<input type="file" accept=".pdf,.txt" onChange={handleResumeUpload} ref={fileInputRef} />` styled with Tailwind (small text, full width)
   - If `isExtracting`: show "Extracting text..." with subtle loading indicator
   - If `resumeStatus`: show status text (green if success, yellow if warning)
   - If `resumePreview`: show preview in a small `<div>` with `text-xs text-gray-500 bg-gray-50 p-2 rounded max-h-20 overflow-y-auto` and truncated text ending with "..."
   - If `hasResume`: show Delete button (small, red text)

   **Job Description section:**
   - Label: "Job Description"
   - Textarea: `<textarea value={jdText} onChange={e => setJdText(e.target.value)} rows={4} className="..." placeholder="Paste job description here..." />`
   - Character count: `<span className="text-xs text-gray-400">{jdText.length}/4000</span>`
   - Save button: `<button onClick={handleJdSave}>Save</button>` styled with Tailwind (blue, small)
   - If `jdSaved`: show "Saved!" text briefly (green)
   - If `hasJD`: show Delete button (small, red text)

2. Add FileUploadSettings to popup `App.tsx`:
   - Import `FileUploadSettings` from `../../src/components/settings/FileUploadSettings`
   - In the `activeTab === 'settings'` section, add a new `<section>` block AFTER the "Models" section and BEFORE the "Hotkeys" section:
     ```tsx
     <section>
       <h2 className="mb-3 text-sm font-semibold text-gray-900">Personalization</h2>
       <FileUploadSettings />
     </section>
     ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx eslint src/components/settings/FileUploadSettings.tsx entrypoints/popup/App.tsx` passes
    - FileUploadSettings component exists and is rendered in the settings tab
  </verify>
  <done>File upload UI exists in popup settings with resume file picker (PDF/TXT), JD textarea with save, text preview, delete buttons, scanned PDF warning, character count, and loading state during extraction.</done>
</task>

<task type="auto">
  <name>Task 2: Modify PromptBuilder and background to inject file context into LLM prompts</name>
  <files>
    src/services/llm/PromptBuilder.ts
    entrypoints/background.ts
  </files>
  <action>
1. Modify `src/services/llm/PromptBuilder.ts`:
   - Add an optional `fileContext` parameter to `buildPrompt`:
     ```typescript
     export interface FileContext {
       resume?: string;
       jobDescription?: string;
     }

     export function buildPrompt(
       request: DualLLMRequest,
       template: PromptTemplate,
       fileContext?: FileContext,
     ): BuildPromptResult {
     ```
   - After the line `const system = substituteVariables(template.systemPrompt, variables);`, change it to `let system = ...` and add file context injection:
     ```typescript
     let system = substituteVariables(template.systemPrompt, variables);

     // Append file context to system prompt if available (Phase 19: File Personalization)
     if (fileContext?.resume || fileContext?.jobDescription) {
       const contextParts: string[] = [];
       if (fileContext.resume) {
         contextParts.push('\n\n## Candidate Background\nThe candidate has the following resume/background:\n' + fileContext.resume);
       }
       if (fileContext.jobDescription) {
         contextParts.push('\n\n## Target Role\nThe candidate is interviewing for this position:\n' + fileContext.jobDescription);
       }
       system += contextParts.join('');
     }
     ```
   - Update the barrel export in `src/services/llm/index.ts` to also export `FileContext`:
     ```typescript
     export { buildPrompt, type BuildPromptResult, type FileContext } from './PromptBuilder';
     ```

2. Modify `entrypoints/background.ts`:
   - Add import at the top with other imports:
     ```typescript
     import { getFileContent } from '../src/services/fileStorage';
     ```
   - In the `handleLLMRequest` function, BEFORE the line `const prompts = buildPrompt(...)`, add IndexedDB read:
     ```typescript
     // Read file context from IndexedDB for prompt personalization (Phase 19)
     const [resumeRecord, jdRecord] = await Promise.all([
       getFileContent('resume'),
       getFileContent('jobDescription'),
     ]);
     const fileContext = (resumeRecord?.text || jdRecord?.text)
       ? { resume: resumeRecord?.text, jobDescription: jdRecord?.text }
       : undefined;
     ```
   - Modify the `buildPrompt` call to pass `fileContext`:
     ```typescript
     const prompts = buildPrompt({ question, recentContext, fullTranscript, templateId }, template, fileContext);
     ```
   - Also add the `type FileContext` import to background.ts if needed (or it will be inferred from buildPrompt's signature)
  </action>
  <verify>
    - `npx tsc --noEmit` passes -- buildPrompt signature change is backward compatible (fileContext is optional)
    - `npx eslint src/services/llm/PromptBuilder.ts entrypoints/background.ts src/services/llm/index.ts` passes
    - Verify `buildPrompt` still works without fileContext (existing callers unaffected)
    - Verify background.ts imports `getFileContent` from fileStorage
  </verify>
  <done>PromptBuilder accepts optional FileContext and appends "Candidate Background" and "Target Role" sections to the system prompt. Background service worker reads resume and JD from IndexedDB before every LLM request and passes them to buildPrompt. The change is backward compatible -- existing calls without fileContext continue to work.</done>
</task>

</tasks>

<verification>
- `npm run dev` or `npx tsc --noEmit` -- no TypeScript errors across the entire project
- `npx eslint .` -- no lint errors
- FileUploadSettings renders in popup settings tab under "Personalization" heading
- PromptBuilder's buildPrompt function accepts optional FileContext parameter
- background.ts reads IndexedDB file records before calling buildPrompt
- System prompt includes "## Candidate Background" section when resume is uploaded
- System prompt includes "## Target Role" section when JD is uploaded
- No changes affect existing functionality when no files are uploaded (fileContext is undefined)
</verification>

<success_criteria>
- User can upload PDF/TXT resume via popup settings and see extracted text preview
- User can paste job description in textarea and save it
- Both resume and JD persist in IndexedDB across browser restarts
- LLM system prompts include file context when resume/JD are available
- Scanned PDFs show a warning when extraction yields very little text
- All TypeScript strict mode and ESLint checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/19-file-personalization/19-02-SUMMARY.md`
</output>
