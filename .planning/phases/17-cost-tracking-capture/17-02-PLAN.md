---
phase: 17-cost-tracking-capture
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - entrypoints/content.tsx
  - src/overlay/ResponsePanel.tsx
  - src/overlay/Overlay.tsx
autonomous: true

must_haves:
  truths:
    - "After each LLM response completes, the overlay shows the cost (e.g., '$0.003') next to that response"
    - "Token counts are visible to the user as part of the cost display"
    - "A running session cost total is visible in the overlay footer during an active interview session"
    - "Dual-stream costs aggregate correctly: fast + full model costs combine into totalCostUSD"
    - "Session cost accumulates across multiple requests and resets on page reload"
  artifacts:
    - path: "entrypoints/content.tsx"
      provides: "LLM_COST message handler that updates LLMResponse cost fields and session total"
      contains: "LLM_COST"
    - path: "src/overlay/ResponsePanel.tsx"
      provides: "Per-request cost badge displayed after response completes"
      contains: "costUSD"
    - path: "src/overlay/Overlay.tsx"
      provides: "Session cost total in overlay footer"
      contains: "sessionCost"
  key_links:
    - from: "entrypoints/content.tsx"
      to: "dispatchLLMResponseUpdate"
      via: "LLM_COST handler updates currentLLMResponse cost fields and dispatches update event"
      pattern: "LLM_COST.*dispatchLLMResponseUpdate"
    - from: "entrypoints/content.tsx"
      to: "src/overlay/Overlay.tsx"
      via: "session-cost-update custom event with cumulative session cost"
      pattern: "session-cost-update"
    - from: "src/overlay/ResponsePanel.tsx"
      to: "LLMResponse.totalCostUSD"
      via: "Reads cost fields from response prop to display cost badge"
      pattern: "totalCostUSD"
---

<objective>
Implement the UI layer for cost tracking: handle LLM_COST messages in the content script, display per-request cost badges in ResponsePanel, and show a running session cost total in the Overlay footer.

Purpose: Make cost data visible to the user so they can monitor spending during interviews.
Output: Per-request cost badge on each response, session cost total in overlay footer, content script handler for LLM_COST messages.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-cost-tracking-capture/17-RESEARCH.md
@.planning/phases/17-cost-tracking-capture/17-01-SUMMARY.md

@entrypoints/content.tsx
@src/overlay/ResponsePanel.tsx
@src/overlay/Overlay.tsx
@src/types/messages.ts
@src/types/transcript.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Content script LLM_COST handler and session cost tracking</name>
  <files>
    entrypoints/content.tsx
  </files>
  <action>
    **1. Add module-level session cost accumulator:**
    ```typescript
    // Session cost tracking (in-memory, resets on page reload)
    let sessionCostUSD = 0;
    ```

    **2. Add custom event type for session cost updates:**
    ```typescript
    export interface SessionCostEventDetail {
      sessionCost: number;
    }
    ```

    **3. Create `handleLLMCost` function:**
    This function processes LLM_COST messages and updates the current LLM response with cost data. It handles dual-stream aggregation (fast + full costs arrive separately).

    ```typescript
    function handleLLMCost(message: LLMCostMessage): void {
      if (!currentLLMResponse || currentLLMResponse.id !== message.responseId) return;
      if (activeResponseId && message.responseId !== activeResponseId) return;

      const response = { ...currentLLMResponse };

      // Update cost for the specific model
      if (message.model === 'fast') {
        response.fastCostUSD = message.costUSD;
      } else if (message.model === 'full') {
        response.fullCostUSD = message.costUSD;
      }

      // Calculate total (sum of whichever costs have arrived)
      response.totalCostUSD = (response.fastCostUSD ?? 0) + (response.fullCostUSD ?? 0);

      // Accumulate into session total
      sessionCostUSD += message.costUSD;

      dispatchLLMResponseUpdate(response);

      // Dispatch session cost update event for Overlay footer
      window.dispatchEvent(
        new CustomEvent<SessionCostEventDetail>('session-cost-update', {
          detail: { sessionCost: sessionCostUSD },
        }),
      );
    }
    ```

    **4. Add LLM_COST case to the message listener switch in `main()`:**
    In the `chrome.runtime.onMessage.addListener` callback, add a case for `'LLM_COST'`:
    ```typescript
    case 'LLM_COST':
      handleLLMCost(message as LLMCostMessage);
      return false;
    ```
    Import `LLMCostMessage` from the messages types.

    **Important:** The `handleLLMCost` function should not duplicate session cost if called multiple times for the same model+response. Since each model (fast/full) sends exactly one LLM_COST message per request, and `sessionCostUSD += message.costUSD` runs once per LLM_COST message, no deduplication is needed.
  </action>
  <verify>
    Run `npx tsc --noEmit` — should pass with zero errors.
    Run `npx eslint entrypoints/content.tsx` — no new lint errors.
  </verify>
  <done>
    Content script handles LLM_COST messages, updates currentLLMResponse with per-model costs (fastCostUSD, fullCostUSD, totalCostUSD), accumulates session cost total, and dispatches session-cost-update custom event for the Overlay footer. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: ResponsePanel cost badge and Overlay session cost footer</name>
  <files>
    src/overlay/ResponsePanel.tsx
    src/overlay/Overlay.tsx
  </files>
  <action>
    **1. Add per-request cost badge to `src/overlay/ResponsePanel.tsx`:**

    After the StatusIndicator in the response header area, add a cost display that shows when the response has cost data. Place it in the header row next to the status indicator:

    In the header `<div>` that contains `<span>AI Response</span>` and `<StatusIndicator>`, modify the right side to include cost:
    ```tsx
    {response && (
      <div className="flex items-center gap-2">
        {response.totalCostUSD != null && response.totalCostUSD > 0 && (
          <span className="text-xs text-white/40" title={`Fast: $${(response.fastCostUSD ?? 0).toFixed(4)} | Full: $${(response.fullCostUSD ?? 0).toFixed(4)}`}>
            ${response.totalCostUSD < 0.01
              ? response.totalCostUSD.toFixed(4)
              : response.totalCostUSD.toFixed(3)}
          </span>
        )}
        <StatusIndicator status={response.status} isReasoningPending={isReasoningPending} />
      </div>
    )}
    ```

    The cost shows after the response starts receiving cost data (totalCostUSD is set). The title tooltip provides per-model breakdown on hover. Format: show 4 decimal places for costs under $0.01 (typical), 3 for larger costs.

    **2. Add session cost total to Overlay footer in `src/overlay/Overlay.tsx`:**

    Add state and event listener for session cost:
    ```typescript
    const [sessionCost, setSessionCost] = useState(0);
    ```

    Add useEffect to listen for session-cost-update events. Import `SessionCostEventDetail` from content.tsx (or define the event detail type locally to avoid circular imports -- define it locally):
    ```typescript
    useEffect(() => {
      const handleSessionCostUpdate = (event: CustomEvent<{ sessionCost: number }>) => {
        setSessionCost(event.detail.sessionCost);
      };
      window.addEventListener('session-cost-update', handleSessionCostUpdate as EventListener);
      return () => {
        window.removeEventListener('session-cost-update', handleSessionCostUpdate as EventListener);
      };
    }, []);
    ```

    In the footer `<div>`, between the "AI Interview Assistant" text and the StatusIndicator, add the session cost display:
    ```tsx
    <div className="flex items-center justify-between border-t border-white/10 px-3 py-1.5 text-xs text-white/60">
      <span>AI Interview Assistant</span>
      <div className="flex items-center gap-2">
        {sessionCost > 0 && (
          <span className="text-white/40" title="Session total cost">
            Session: ${sessionCost < 0.01 ? sessionCost.toFixed(4) : sessionCost.toFixed(3)}
          </span>
        )}
        <StatusIndicator
          status={displayResponse?.status ?? null}
          isReasoningPending={isReasoningPending}
        />
      </div>
    </div>
    ```

    This wraps the right side of the footer in a flex container with a gap, showing session cost when > 0 and the existing StatusIndicator.
  </action>
  <verify>
    Run `npx tsc --noEmit` — should pass with zero errors.
    Run `npx eslint src/overlay/ entrypoints/content.tsx` — no new lint errors.
    Run `npm run dev` — extension builds without errors.
  </verify>
  <done>
    ResponsePanel shows per-request cost badge (with hover tooltip for fast/full breakdown) next to the status indicator. Overlay footer displays session cost total that accumulates across requests. Cost formatting adapts to magnitude (4 decimal places for sub-cent costs, 3 for larger). Both components update reactively as LLM_COST messages arrive.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — all component types match updated LLMResponse interface
2. `npx eslint .` passes — no lint errors in any modified file
3. `npm run dev` or `npm run build` produces a working extension
4. ResponsePanel renders cost badge when response.totalCostUSD > 0
5. Overlay footer shows "Session: $X.XXXX" when sessionCost > 0
6. Cost tooltip on ResponsePanel shows fast/full breakdown
7. Session cost accumulates across multiple LLM requests
8. Page reload resets session cost to 0 (expected behavior)
</verification>

<success_criteria>
- After each LLM response, the overlay shows cost next to that response (COST-02)
- Token counts are captured and used for cost calculation (COST-01, via Plan 01)
- Session cost total is visible in the overlay footer during active session (COST-03)
- Dual-stream costs (fast + full) aggregate correctly into totalCostUSD
- No TypeScript errors, no ESLint errors, extension builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/17-cost-tracking-capture/17-02-SUMMARY.md`
</output>
