---
phase: 13-compliance-ui
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/consent/PrivacyConsentModal.tsx
  - src/components/consent/RecordingConsentWarning.tsx
  - src/components/settings/ConsentSettings.tsx
  - entrypoints/popup/App.tsx
autonomous: true

must_haves:
  truths:
    - "On first extension use, a blocking privacy consent modal appears that must be accepted before any functionality is available"
    - "The privacy policy document is accessible from the extension UI at any time"
    - "Before each recording session, a dismissable recording consent warning appears reminding the user about audio capture"
    - "A user who previously dismissed the per-session warning with 'don't show again' does not see it on subsequent sessions"
    - "A settings option exists to reset all consent acknowledgments"
  artifacts:
    - path: "src/components/consent/PrivacyConsentModal.tsx"
      provides: "First-time blocking consent modal with privacy policy and accept button"
      exports: ["PrivacyConsentModal"]
    - path: "src/components/consent/RecordingConsentWarning.tsx"
      provides: "Per-session recording consent warning with 'don't show again' checkbox"
      exports: ["RecordingConsentWarning"]
    - path: "src/components/settings/ConsentSettings.tsx"
      provides: "Settings section with reset all consents button"
      exports: ["default"]
    - path: "entrypoints/popup/App.tsx"
      provides: "Consent-gated popup with privacy modal blocking and recording consent intercept"
      contains: "PrivacyConsentModal"
  key_links:
    - from: "entrypoints/popup/App.tsx"
      to: "src/components/consent/PrivacyConsentModal.tsx"
      via: "conditional render gate before main content"
      pattern: "if.*!privacyPolicyAccepted.*PrivacyConsentModal"
    - from: "entrypoints/popup/App.tsx"
      to: "src/components/consent/RecordingConsentWarning.tsx"
      via: "capture flow intercept before doStartCapture"
      pattern: "showRecordingConsent.*RecordingConsentWarning"
    - from: "entrypoints/popup/App.tsx"
      to: "src/store/index.ts"
      via: "useStore selectors for consent state"
      pattern: "useStore.*privacyPolicyAccepted"
    - from: "src/components/settings/ConsentSettings.tsx"
      to: "src/store/index.ts"
      via: "useStore selector for resetAllConsents action"
      pattern: "useStore.*resetAllConsents"
---

<objective>
Create the consent UI components and integrate them into the popup as blocking gates.

Purpose: Implement the two consent flows (first-time privacy policy + per-session recording warning), the always-accessible privacy policy view, and the settings reset option. This satisfies all five Phase 13 success criteria.

Output: Three new UI components wired into App.tsx as consent gates, plus a consent reset section in Settings.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-compliance-ui/13-01-SUMMARY.md
@entrypoints/popup/App.tsx
@src/components/settings/BlurSettings.tsx
@src/components/consent/PrivacyPolicyContent.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PrivacyConsentModal and RecordingConsentWarning components</name>
  <files>src/components/consent/PrivacyConsentModal.tsx, src/components/consent/RecordingConsentWarning.tsx</files>
  <action>
**PrivacyConsentModal.tsx:**

A full-screen blocking modal (fills the popup) that displays:
1. Header: "Welcome to AI Interview Assistant"
2. Subheader: "Please review our privacy policy before using the extension"
3. The `PrivacyPolicyContent` component (imported from same directory) in a scrollable container
4. An "I Accept" button at the bottom that calls the `onAccept` prop callback
5. A note: "You must accept to use this extension"

Props: `{ onAccept: () => void }`

Styling: Full popup width (`w-full`), white background, padding, the policy content in a scrollable container with border, the accept button styled as primary action (blue-600 bg, white text, full width, rounded-lg). Match existing popup styling patterns (gray-900 headings, gray-700 text).

Do NOT use a backdrop overlay or portal -- this replaces the entire popup content via conditional rendering in App.tsx (not overlaid on top of it).

**RecordingConsentWarning.tsx:**

A warning dialog that appears inline in the capture tab when the user clicks Start:
1. Warning icon or header: "Recording Consent"
2. Text: "This will capture audio from your browser tab and microphone. Audio is transcribed in real-time and sent to your configured AI services. No audio is recorded or stored."
3. A checkbox: "Don't show this again"
4. Two buttons: "Cancel" (secondary, dismisses) and "Proceed" (primary, starts capture)

Props:
```typescript
{
  onProceed: (dontShowAgain: boolean) => void;
  onCancel: () => void;
}
```

Styling: Warning-themed with amber/yellow border and background, rounded-lg, padding. Checkbox with label. Buttons styled consistently with existing popup buttons (Cancel as gray outline, Proceed as green-600 matching the Start button).

Component manages its own `dontShowAgain` checkbox state via `useState(false)`. When "Proceed" is clicked, calls `onProceed(dontShowAgain)`. When "Cancel" is clicked, calls `onCancel()`.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify both files exist with correct exports.</verify>
  <done>PrivacyConsentModal renders privacy policy with accept button. RecordingConsentWarning renders audio capture warning with "don't show again" checkbox and proceed/cancel buttons.</done>
</task>

<task type="auto">
  <name>Task 2: Create ConsentSettings component for settings tab</name>
  <files>src/components/settings/ConsentSettings.tsx</files>
  <action>
Create `ConsentSettings.tsx` following the exact pattern of `BlurSettings.tsx`:

1. Import `useStore` from `../../store`
2. Get `resetAllConsents` action, `privacyPolicyAccepted`, and `privacyPolicyAcceptedAt` from store
3. Display:
   - Section showing current consent status:
     - "Privacy policy: Accepted on [date]" or "Privacy policy: Not accepted"
     - "Recording consent: Permanently dismissed" or "Recording consent: Will show before each session"
   - A descriptive paragraph explaining what reset does
   - A "Reset All Consents" button styled as a destructive action (red-100 bg, red-700 text, hover:red-200)
   - After clicking reset, the user will immediately see the privacy consent modal (because App.tsx re-renders with privacyPolicyAccepted=false)

Additionally, add a "View Privacy Policy" section with a link/button that shows the privacy policy. Implementation: Use a local `useState(false)` to toggle showing `PrivacyPolicyContent` inline within the settings tab. This satisfies success criteria #2: "privacy policy document is accessible from the extension UI at any time."

Export as default: `export default function ConsentSettings()`.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify file exports default function component.</verify>
  <done>ConsentSettings component shows consent status, view privacy policy toggle, and reset button. Accessible from Settings tab.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate consent gates into popup App.tsx</name>
  <files>entrypoints/popup/App.tsx</files>
  <action>
Modify `entrypoints/popup/App.tsx` to wire in the consent flows:

**1. Add imports:**
```typescript
import PrivacyConsentModal from '../../src/components/consent/PrivacyConsentModal';
import RecordingConsentWarning from '../../src/components/consent/RecordingConsentWarning';
import ConsentSettings from '../../src/components/settings/ConsentSettings';
```

**2. Add consent state subscriptions (inside App function, near other useStore calls):**
```typescript
const privacyPolicyAccepted = useStore((state) => state.privacyPolicyAccepted);
const acceptPrivacyPolicy = useStore((state) => state.acceptPrivacyPolicy);
const recordingConsentDismissed = useStore((state) => state.recordingConsentDismissedPermanently);
const dismissRecordingConsentPermanently = useStore((state) => state.dismissRecordingConsentPermanently);
```

**3. Add recording consent local state:**
```typescript
const [showRecordingConsent, setShowRecordingConsent] = useState(false);
```

**4. Modify handleStartCapture to intercept with recording consent:**

Before the existing `handleStartCapture` function body, add a consent gate check. The cleanest approach: rename the existing `handleStartCapture` to `doStartCapture` (private). Create a new `handleStartCapture` that checks consent first:

```typescript
async function doStartCapture() {
  // ... existing handleStartCapture body (everything from the ref check onwards)
}

async function handleStartCapture() {
  if (!recordingConsentDismissed) {
    setShowRecordingConsent(true);
    return;
  }
  await doStartCapture();
}

function handleRecordingConsentProceed(dontShowAgain: boolean) {
  if (dontShowAgain) {
    dismissRecordingConsentPermanently();
  }
  setShowRecordingConsent(false);
  doStartCapture();
}

function handleRecordingConsentCancel() {
  setShowRecordingConsent(false);
}
```

**5. Add blocking privacy consent gate in the render:**

At the top of the return statement, before the main content div:
```tsx
if (!privacyPolicyAccepted) {
  return <PrivacyConsentModal onAccept={acceptPrivacyPolicy} />;
}
```

**6. Add RecordingConsentWarning in capture tab:**

Inside the capture tab content (where `activeTab === 'capture'`), add the RecordingConsentWarning conditionally:
```tsx
{showRecordingConsent && (
  <RecordingConsentWarning
    onProceed={handleRecordingConsentProceed}
    onCancel={handleRecordingConsentCancel}
  />
)}
```

Place it after the Audio Capture section so it appears prominently when triggered.

**7. Add ConsentSettings to settings tab:**

In the settings tab content (`activeTab === 'settings'`), add a new section at the bottom:
```tsx
<section>
  <h2 className="text-sm font-semibold text-gray-900 mb-3">Privacy & Consent</h2>
  <ConsentSettings />
</section>
```

CRITICAL NOTES:
- The privacy consent gate (`if (!privacyPolicyAccepted)`) MUST be before the main return -- it replaces all popup content, including tabs.
- Do NOT add consent gates to the content script overlay. Audio capture always starts from the popup Start button. The popup gate is sufficient.
- The `doStartCapture` rename is internal only -- the `onClick` handler on the Start button should still reference `handleStartCapture` (the gated version).
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no type errors.
2. Run `npx wxt build` -- extension builds successfully.
3. Verify all five success criteria are addressed:
   - SC1: `if (!privacyPolicyAccepted)` gate returns PrivacyConsentModal
   - SC2: ConsentSettings has "View Privacy Policy" toggle in Settings tab
   - SC3: handleStartCapture checks recordingConsentDismissed before proceeding
   - SC4: dismissRecordingConsentPermanently persists via store
   - SC5: ConsentSettings has resetAllConsents button
  </verify>
  <done>Popup shows privacy consent modal on first use (blocking all tabs). Recording consent warning appears before each capture start until permanently dismissed. Privacy policy accessible from Settings. Reset consents button exists in Settings. All five Phase 13 success criteria satisfied.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx wxt build` succeeds
3. PrivacyConsentModal blocks popup until accepted (success criteria 1)
4. Privacy policy accessible from Settings > Privacy & Consent (success criteria 2)
5. RecordingConsentWarning shows before capture start (success criteria 3)
6. "Don't show again" checkbox persists via store (success criteria 4)
7. Reset All Consents button in Settings re-triggers both flows (success criteria 5)
</verification>

<success_criteria>
- Opening popup for first time shows PrivacyConsentModal blocking all other content
- Accepting privacy policy reveals normal tabbed interface
- Clicking Start shows RecordingConsentWarning before capture begins
- Checking "Don't show again" + Proceed prevents future recording warnings
- Settings tab has Privacy & Consent section with view policy and reset button
- Clicking Reset All Consents immediately shows privacy consent modal again
- TypeScript and WXT build both pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-compliance-ui/13-02-SUMMARY.md`
</output>
