---
phase: 07-integration
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/store/types.ts
  - src/store/settingsSlice.ts
  - src/store/index.ts
  - src/hooks/useCaptureMode.ts
  - src/components/settings/HotkeySettings.tsx
autonomous: true

must_haves:
  truths:
    - "User can select toggle mode in settings"
    - "Toggle mode: press hotkey once to start capture, press again to stop and send"
    - "Hold mode remains the default behavior"
    - "Mode preference persists across browser sessions"
  artifacts:
    - path: "src/store/types.ts"
      provides: "CaptureMode type definition"
      contains: "CaptureMode"
    - path: "src/store/settingsSlice.ts"
      provides: "captureMode setting with setter"
      contains: "captureMode"
    - path: "src/hooks/useCaptureMode.ts"
      provides: "Toggle mode implementation in hook"
      contains: "toggle"
    - path: "src/components/settings/HotkeySettings.tsx"
      provides: "UI for capture mode selection"
      contains: "captureMode"
  key_links:
    - from: "src/hooks/useCaptureMode.ts"
      to: "src/store"
      via: "useStore subscription for captureMode"
      pattern: "captureMode"
    - from: "src/components/settings/HotkeySettings.tsx"
      to: "src/store"
      via: "setCaptureMode action"
      pattern: "setCaptureMode"
---

<objective>
Implement toggle mode for capture hotkey (KEY-03 requirement).

Purpose: Users can choose between hold-to-capture (default) and toggle mode. In toggle mode, pressing the hotkey once starts capture, pressing again stops and sends to LLM. This provides an alternative interaction pattern for users who find holding the key uncomfortable.

Output: Extended store with captureMode setting, updated useCaptureMode hook with toggle behavior, UI toggle in HotkeySettings.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration/07-CONTEXT.md
@src/store/types.ts
@src/store/settingsSlice.ts
@src/store/index.ts
@src/hooks/useCaptureMode.ts
@src/components/settings/HotkeySettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add captureMode setting to store</name>
  <files>src/store/types.ts, src/store/settingsSlice.ts, src/store/index.ts</files>
  <action>
1. Update `src/store/types.ts`:

   Add new type for capture mode:
   ```typescript
   /**
    * Capture mode for hotkey behavior
    * - 'hold': Hold hotkey to capture, release to send (default)
    * - 'toggle': Press once to start capture, press again to stop and send
    */
   export type CaptureMode = 'hold' | 'toggle';
   ```

   Add to SettingsSlice interface:
   ```typescript
   /** Capture mode: hold-to-capture or toggle */
   captureMode: CaptureMode;
   /** Set capture mode */
   setCaptureMode: (mode: CaptureMode) => void;
   ```

2. Update `src/store/settingsSlice.ts`:

   Add default value:
   ```typescript
   captureMode: 'hold' as const,
   ```

   Add action:
   ```typescript
   setCaptureMode: (mode: CaptureMode) => {
     set(() => ({
       captureMode: mode,
     }));
   },
   ```

   Make sure to import CaptureMode type.

3. Update `src/store/index.ts`:

   Add captureMode to the partialize function:
   ```typescript
   partialize: (state) => ({
     apiKeys: state.apiKeys,
     models: state.models,
     blurLevel: state.blurLevel,
     hotkeys: state.hotkeys,
     captureMode: state.captureMode,  // ADD THIS
     templates: state.templates,
     activeTemplateId: state.activeTemplateId,
   }),
   ```

   Add to the re-exports at the bottom:
   ```typescript
   export type { CaptureMode } from './types';
   ```
  </action>
  <verify>
Check types: `grep -q "CaptureMode" src/store/types.ts`
Check slice: `grep -q "captureMode" src/store/settingsSlice.ts`
Check export: `grep -q "captureMode" src/store/index.ts`
TypeScript check: `cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension && npx tsc --noEmit 2>&1 | head -20`
  </verify>
  <done>captureMode setting added to store with 'hold' default and setCaptureMode action</done>
</task>

<task type="auto">
  <name>Task 2: Implement toggle mode in useCaptureMode hook</name>
  <files>src/hooks/useCaptureMode.ts</files>
  <action>
Modify `src/hooks/useCaptureMode.ts` to support toggle mode:

1. Subscribe to captureMode from store:
   ```typescript
   const captureMode = useStore((state) => state.captureMode);
   ```

2. Update handleKeyDown to support toggle mode:

   For toggle mode behavior:
   - First press: Start capturing (set isHolding=true, record startTime)
   - Second press: Stop capturing and send (same as keyUp in hold mode)

   Modify the section after highlight text check:
   ```typescript
   // Toggle mode: press toggles capture state
   if (captureMode === 'toggle') {
     if (isHoldingRef.current) {
       // Currently capturing - stop and send (like keyUp in hold mode)
       const startTime = captureStartTimeRef.current;
       isHoldingRef.current = false;
       captureStartTimeRef.current = null;

       const capturedText = startTime ? getTranscriptSince(startTime) : '';

       setState({
         isHolding: false,
         captureStartTime: null,
         capturedText,
         mode: 'hold',  // Keep 'hold' for consistency in CaptureState type
       });

       if (capturedText.trim()) {
         onCapture(capturedText, 'hold');
       }
       return;
     } else {
       // Not capturing - start capture
       const startTime = Date.now();
       isHoldingRef.current = true;
       captureStartTimeRef.current = startTime;

       setState({
         isHolding: true,
         captureStartTime: startTime,
         capturedText: '',
         mode: 'hold',
       });
       return;
     }
   }

   // Hold mode (default): start capture on keydown
   const startTime = Date.now();
   // ... rest of existing hold mode code
   ```

3. Update handleKeyUp for hold mode only:

   At the start of handleKeyUp, add early return for toggle mode:
   ```typescript
   // In toggle mode, keyUp does nothing (all logic in keyDown)
   if (captureMode === 'toggle') return;
   ```

4. Update useCallback dependencies:
   - Add `captureMode` to handleKeyDown dependencies
   - Add `captureMode` to handleKeyUp dependencies

Note: The mode field in CaptureState stays as 'hold' even in toggle mode since it refers to HOW the text was captured (hold vs highlight), not the settings mode.
  </action>
  <verify>
Check toggle mode support: `grep -q "captureMode === 'toggle'" src/hooks/useCaptureMode.ts`
Check store subscription: `grep -q "state.captureMode\|captureMode" src/hooks/useCaptureMode.ts`
Build passes: `cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension && npm run build`
  </verify>
  <done>useCaptureMode hook supports both hold and toggle modes based on store setting</done>
</task>

<task type="auto">
  <name>Task 3: Add capture mode toggle to HotkeySettings UI</name>
  <files>src/components/settings/HotkeySettings.tsx</files>
  <action>
Modify `src/components/settings/HotkeySettings.tsx` to add capture mode selection:

1. Import CaptureMode type:
   ```typescript
   import type { CaptureMode } from '../../store';
   ```

2. Subscribe to captureMode and setCaptureMode:
   ```typescript
   const captureMode = useStore((state) => state.captureMode);
   const setCaptureMode = useStore((state) => state.setCaptureMode);
   ```

3. Add mode selection UI after the hotkey input section:
   ```tsx
   {/* Capture Mode Selection */}
   <div className="mt-4 pt-4 border-t border-gray-200">
     <label className="block text-sm font-medium text-gray-700 mb-2">
       Capture Mode
     </label>
     <div className="space-y-2">
       <label className="flex items-start gap-3 cursor-pointer">
         <input
           type="radio"
           name="captureMode"
           value="hold"
           checked={captureMode === 'hold'}
           onChange={() => setCaptureMode('hold')}
           className="mt-0.5"
         />
         <div>
           <span className="text-sm font-medium text-gray-900">Hold to capture</span>
           <p className="text-xs text-gray-500">
             Hold hotkey while speaking, release to send
           </p>
         </div>
       </label>
       <label className="flex items-start gap-3 cursor-pointer">
         <input
           type="radio"
           name="captureMode"
           value="toggle"
           checked={captureMode === 'toggle'}
           onChange={() => setCaptureMode('toggle')}
           className="mt-0.5"
         />
         <div>
           <span className="text-sm font-medium text-gray-900">Toggle mode</span>
           <p className="text-xs text-gray-500">
             Press once to start capture, press again to stop and send
           </p>
         </div>
       </label>
     </div>
   </div>
   ```

The UI provides clear descriptions of each mode so users understand the behavior difference.
  </action>
  <verify>
Check UI exists: `grep -q "Capture Mode" src/components/settings/HotkeySettings.tsx`
Check radio inputs: `grep -q "captureMode === 'toggle'" src/components/settings/HotkeySettings.tsx`
Build passes: `cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension && npm run build`
  </verify>
  <done>HotkeySettings shows capture mode selection with hold and toggle options</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. CaptureMode type exported from store
3. captureMode setting persists in chrome.storage (check partialize)
4. useCaptureMode hook reads captureMode from store
5. HotkeySettings shows mode selection UI
6. Hold mode works as before (default)
7. Toggle mode: first press starts capture, second press sends
</verification>

<success_criteria>
1. CaptureMode type defined with 'hold' | 'toggle' values
2. Store has captureMode setting with 'hold' default
3. Setting persists across browser sessions
4. useCaptureMode hook implements toggle behavior
5. HotkeySettings shows radio buttons for mode selection
6. Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration/07-04-SUMMARY.md`
</output>
