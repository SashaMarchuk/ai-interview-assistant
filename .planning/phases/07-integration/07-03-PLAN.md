---
phase: 07-integration
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/overlay/Overlay.tsx
autonomous: false

must_haves:
  truths:
    - "User sees health indicator update when STT reconnects"
    - "Full end-to-end flow works: transcript appears, hotkey triggers LLM, response streams"
    - "Blur level changes in settings apply immediately to overlay"
    - "Overlay shows setup prompt when both API keys missing"
  artifacts:
    - path: "src/overlay/Overlay.tsx"
      provides: "Integrated overlay with connection state handling"
      contains: "connection-state-update"
  key_links:
    - from: "src/overlay/Overlay.tsx"
      to: "entrypoints/content.tsx"
      via: "connection-state-update event listener"
      pattern: "addEventListener.*connection-state-update"
---

<objective>
Wire connection state to HealthIndicator and perform end-to-end verification.

Purpose: Complete the integration by connecting the connection state events (from Plan 02) to the HealthIndicator UI (from Plan 01), then verify the full end-to-end flow works correctly on Google Meet.

Output: Fully integrated overlay that displays real-time service health, followed by human verification of complete functionality.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration/07-CONTEXT.md
@.planning/phases/07-integration/07-RESEARCH.md
@src/overlay/Overlay.tsx
@entrypoints/content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire connection state events to HealthIndicator</name>
  <files>src/overlay/Overlay.tsx</files>
  <action>
Add connection state event handling to Overlay.tsx:

1. Import ConnectionStateEventDetail type from content.tsx:
   ```typescript
   import type { ConnectionStateEventDetail } from '../../entrypoints/content';
   ```

2. Add useEffect to listen for connection-state-update events:
   ```typescript
   // Listen for connection state updates from background
   useEffect(() => {
     function handleConnectionStateUpdate(event: Event) {
       const customEvent = event as CustomEvent<ConnectionStateEventDetail>;
       const { service, state, error } = customEvent.detail;

       setHealthIssues(prev => {
         // Remove existing issue for this service
         const filtered = prev.filter(i => i.service !== service);

         // Only add issue if not connected
         if (state !== 'connected') {
           const statusMap: Record<string, 'warning' | 'error' | 'reconnecting'> = {
             disconnected: 'warning',
             reconnecting: 'reconnecting',
             error: 'error',
           };
           const messageMap: Record<string, string> = {
             disconnected: 'Disconnected',
             reconnecting: 'Reconnecting...',
             error: error || 'Connection error',
           };

           const serviceName = service === 'stt-tab' ? 'Tab STT'
                            : service === 'stt-mic' ? 'Mic STT'
                            : 'LLM';

           filtered.push({
             service,
             status: statusMap[state] || 'error',
             message: `${serviceName}: ${messageMap[state] || state}`,
           });
         }

         return filtered;
       });
     }

     window.addEventListener('connection-state-update', handleConnectionStateUpdate);
     return () => {
       window.removeEventListener('connection-state-update', handleConnectionStateUpdate);
     };
   }, []);
   ```

3. Ensure HealthIssue type includes 'service' field:
   ```typescript
   type HealthIssue = {
     service: string;
     status: 'warning' | 'error' | 'reconnecting';
     message: string;
   };
   ```

This connects the connection state events (dispatched by content.tsx from Plan 02) to the HealthIndicator component (created in Plan 01).
  </action>
  <verify>
Check event listener: `grep -q "connection-state-update" src/overlay/Overlay.tsx`
Build passes: `cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension && npm run build`
  </verify>
  <done>Overlay listens for connection state events and updates HealthIndicator</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 7 Integration:
1. HealthIndicator component that only shows when issues exist
2. Graceful degradation in popup with warnings for missing API keys
3. Setup prompt in overlay when both API keys missing
4. Connection state broadcasting from offscreen through background to content
5. LLM retry logic (3 retries with backoff)
6. Full wiring from connection state events to HealthIndicator UI
  </what-built>
  <how-to-verify>
**Test 1: Missing API Keys Behavior**
1. Open extension popup, go to Settings, clear both API keys
2. Go to Capture tab - should see yellow warnings about missing keys
3. Go to a Google Meet page - overlay should show "Configure API keys" prompt
4. Warnings should NOT block starting capture (informational only)

**Test 2: Partial Configuration**
1. Set only ElevenLabs API key (leave OpenRouter empty)
2. Start capture and transcription - should work
3. Hold hotkey - should see error about missing OpenRouter key in overlay
4. HealthIndicator should show LLM error

**Test 3: Full End-to-End Flow**
1. Set both API keys in Settings
2. Navigate to Google Meet (can be test meeting or https://meet.google.com/xxx-xxxx-xxx)
3. Start capture in popup
4. Start transcription in popup
5. Speak into microphone - transcript should appear in overlay
6. Hold capture hotkey (default: Ctrl+Shift+Space), then release
7. Should see:
   - Capture indicator while holding
   - Fast hint appears within 2-3 seconds
   - Full answer streams simultaneously
8. Both responses complete with green "Ready" status

**Test 4: Settings Reactivity**
1. While on Google Meet with overlay visible
2. Open popup, go to Settings
3. Change blur level slider
4. Overlay blur should update immediately (live)

**Test 5: Health Indicator**
1. With transcription running, HealthIndicator should NOT be visible (everything working)
2. Simulate disconnect by turning off network briefly
3. Should see "Reconnecting..." indicator
4. Turn network back on - indicator should disappear when reconnected
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Overlay wired to connection state events
3. Human verification of all integration points
</verification>

<success_criteria>
1. Connection state events update HealthIndicator in real-time
2. Missing API keys show appropriate warnings (popup) and prompts (overlay)
3. Full end-to-end flow works on Google Meet
4. Settings changes apply correctly (blur level live, API keys require restart)
5. Health indicator only visible when issues exist
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration/07-03-SUMMARY.md`
</output>
