---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/entrypoints/offscreen/index.html
  - src/entrypoints/offscreen/index.ts
  - src/entrypoints/content.tsx
  - src/components/OverlayPlaceholder.tsx
autonomous: true

must_haves:
  truths:
    - "Offscreen Document loads and communicates with Service Worker"
    - "Content Script injects placeholder UI on Google Meet pages"
    - "Placeholder UI is isolated in Shadow DOM"
    - "Extension shows no CSP errors in console"
  artifacts:
    - path: "src/entrypoints/offscreen/index.html"
      provides: "Offscreen document HTML"
      contains: "script"
    - path: "src/entrypoints/offscreen/index.ts"
      provides: "Offscreen message handler"
      contains: "chrome.runtime.onMessage"
    - path: "src/entrypoints/content.tsx"
      provides: "Content script entry"
      contains: "defineContentScript"
    - path: "src/components/OverlayPlaceholder.tsx"
      provides: "Placeholder overlay component"
      min_lines: 15
  key_links:
    - from: "src/entrypoints/offscreen/index.ts"
      to: "src/entrypoints/background.ts"
      via: "chrome.runtime.sendMessage"
      pattern: "OFFSCREEN_READY"
    - from: "src/entrypoints/content.tsx"
      to: "src/components/OverlayPlaceholder.tsx"
      via: "React render"
      pattern: "OverlayPlaceholder"
---

<objective>
Implement Offscreen Document and Content Script with placeholder overlay UI.

Purpose: Complete the extension component architecture with all four communication endpoints.
Output: Working Offscreen Document and Content Script that inject UI into Google Meet.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Offscreen Document</name>
  <files>
    src/entrypoints/offscreen/index.html
    src/entrypoints/offscreen/index.ts
  </files>
  <action>
    Create the Offscreen Document entrypoint. WXT expects offscreen documents in src/entrypoints/offscreen/.

    Create src/entrypoints/offscreen/index.html:
    ```html
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>AI Interview Assistant - Offscreen</title>
    </head>
    <body>
      <!-- Offscreen document has no visible UI -->
      <script src="./index.ts" type="module"></script>
    </body>
    </html>
    ```

    Create src/entrypoints/offscreen/index.ts:
    ```typescript
    import type { ExtensionMessage } from '@/types/messages';
    import { isMessage } from '@/types/messages';

    console.log('Offscreen document initializing...');

    // Listen for messages from service worker
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      handleMessage(message, sender)
        .then(sendResponse)
        .catch((error) => {
          console.error('Offscreen message error:', error);
          sendResponse({ error: error.message });
        });
      return true; // Keep channel open for async response
    });

    async function handleMessage(
      message: ExtensionMessage,
      sender: chrome.runtime.MessageSender
    ): Promise<unknown> {
      console.log('Offscreen received message:', message.type);

      // Phase 1: Just acknowledge messages
      // Future phases will add:
      // - Audio processing (Phase 2)
      // - WebSocket management (Phase 3)

      return { received: true, type: message.type };
    }

    // Notify service worker that offscreen is ready
    // Small delay to ensure message listener is set up
    setTimeout(() => {
      chrome.runtime.sendMessage({ type: 'OFFSCREEN_READY' })
        .then(() => console.log('Offscreen ready notification sent'))
        .catch((error) => console.error('Failed to notify ready:', error));
    }, 100);

    console.log('Offscreen document initialized');
    ```

    Note: The offscreen document runs in its own context. It will be used for WebSocket connections in Phase 3 (due to Service Worker 30-second timeout limitation).
  </action>
  <verify>
    After loading extension and clicking "Create Offscreen" in popup:
    - No errors in extension console
    - Service Worker console shows "Offscreen document is ready"
    - Offscreen document console (via chrome://extensions -> Inspect views -> offscreen.html) shows "Offscreen document initialized"
  </verify>
  <done>
    Offscreen Document loads successfully.
    Offscreen Document communicates with Service Worker.
    Ready for WebSocket integration in future phases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Content Script with Shadow DOM overlay</name>
  <files>
    src/entrypoints/content.tsx
    src/components/OverlayPlaceholder.tsx
  </files>
  <action>
    Create the Content Script that injects a placeholder overlay on Google Meet pages.

    Create src/entrypoints/content.tsx:
    ```typescript
    import { createRoot } from 'react-dom/client';
    import OverlayPlaceholder from '@/components/OverlayPlaceholder';

    // Only inject on active Google Meet meeting pages
    const MEET_URL_PATTERN = /^https:\/\/meet\.google\.com\/[a-z]{3}-[a-z]{4}-[a-z]{3}/i;

    export default defineContentScript({
      matches: ['https://meet.google.com/*'],
      runAt: 'document_idle',
      cssInjectionMode: 'ui',

      async main(ctx) {
        // Check if this is an active meeting page (not landing/join page)
        if (!MEET_URL_PATTERN.test(window.location.href)) {
          console.log('AI Interview Assistant: Not a meeting page, skipping injection');
          return;
        }

        console.log('AI Interview Assistant: Content script loaded on Meet page');

        // Create UI container using WXT's createShadowRootUi for proper isolation
        const ui = await createShadowRootUi(ctx, {
          name: 'ai-interview-assistant',
          position: 'inline',
          anchor: 'body',
          onMount: (container) => {
            // Create React root inside shadow DOM
            const root = createRoot(container);
            root.render(<OverlayPlaceholder />);
            return root;
          },
          onRemove: (root) => {
            root?.unmount();
          },
        });

        ui.mount();
        console.log('AI Interview Assistant: Overlay injected into Shadow DOM');

        // Notify background that UI is ready
        try {
          await chrome.runtime.sendMessage({
            type: 'UI_INJECTED',
            success: true,
          });
        } catch (error) {
          console.warn('Failed to notify UI injection:', error);
        }
      },
    });
    ```

    Create src/components/OverlayPlaceholder.tsx:
    ```typescript
    import { useState } from 'react';

    export default function OverlayPlaceholder() {
      const [isMinimized, setIsMinimized] = useState(false);

      if (isMinimized) {
        return (
          <div
            className="fixed bottom-4 right-4 z-[999999]"
            style={{ fontFamily: 'system-ui, sans-serif' }}
          >
            <button
              onClick={() => setIsMinimized(false)}
              className="bg-blue-500 text-white px-3 py-2 rounded-lg shadow-lg hover:bg-blue-600 text-sm font-medium"
            >
              AI Assistant
            </button>
          </div>
        );
      }

      return (
        <div
          className="fixed bottom-4 right-4 w-80 z-[999999]"
          style={{ fontFamily: 'system-ui, sans-serif' }}
        >
          <div className="bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-gray-200 overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-4 py-2 bg-gray-50 border-b">
              <span className="font-medium text-gray-700 text-sm">
                AI Interview Assistant
              </span>
              <button
                onClick={() => setIsMinimized(true)}
                className="text-gray-400 hover:text-gray-600 text-lg leading-none"
              >
                âˆ’
              </button>
            </div>

            {/* Content */}
            <div className="p-4">
              {/* Transcript placeholder */}
              <div className="mb-3">
                <div className="text-xs font-medium text-gray-500 mb-1">
                  Transcript
                </div>
                <div className="bg-gray-50 rounded p-2 text-sm text-gray-400 italic h-20 overflow-y-auto">
                  Waiting for audio...
                </div>
              </div>

              {/* Response placeholder */}
              <div>
                <div className="text-xs font-medium text-gray-500 mb-1">
                  AI Response
                </div>
                <div className="bg-gray-50 rounded p-2 text-sm text-gray-400 italic h-24 overflow-y-auto">
                  Hold hotkey to capture question...
                </div>
              </div>
            </div>

            {/* Footer */}
            <div className="px-4 py-2 bg-gray-50 border-t text-xs text-gray-400">
              Phase 1 - Foundation
            </div>
          </div>
        </div>
      );
    }
    ```

    Note: WXT's createShadowRootUi handles CSS injection into Shadow DOM automatically when cssInjectionMode: 'ui' is set.
  </action>
  <verify>
    Navigate to https://meet.google.com/abc-defg-hij (any valid meeting URL pattern).
    Verify:
    - Overlay appears in bottom-right corner
    - Overlay has placeholder text
    - Minimize button works (collapses to small button)
    - Styles are applied (shadow, rounded corners, colors)
    - Page styles don't affect overlay (Shadow DOM isolation)
  </verify>
  <done>
    Content Script loads on Google Meet meeting pages.
    Placeholder overlay renders with Tailwind styles.
    Shadow DOM provides CSS isolation from page.
    Minimize/expand functionality works.
  </done>
</task>

</tasks>

<verification>
1. Offscreen Document initializes and sends OFFSCREEN_READY
2. Content Script injects overlay on Google Meet meeting URLs
3. Overlay is visible with proper styling (not affected by Meet CSS)
4. Minimize/expand toggle works
5. No CSP errors in any console (extension, page, offscreen)
6. All four components can communicate: Popup <-> SW <-> Offscreen, SW <-> Content
</verification>

<success_criteria>
- Offscreen Document loads and communicates bidirectionally with Service Worker
- Content Script injects only on active meeting pages (not landing page)
- Overlay uses Shadow DOM for CSS isolation
- Placeholder UI shows transcript and response areas
- Extension loads without any CSP errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
