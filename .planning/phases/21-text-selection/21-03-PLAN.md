---
phase: 21-text-selection
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/components/settings/QuickPromptSettings.tsx
  - entrypoints/popup/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a 'Quick Prompts' section in popup settings with all configured actions listed"
    - "User can add a new quick prompt action with label, icon, and prompt template (up to max 4)"
    - "User can edit an existing quick prompt's label, icon, and prompt template"
    - "User can remove a quick prompt action from the list"
    - "User can reorder quick prompts via drag-and-drop with visible grab handles"
    - "User can reset to the 4 default quick prompts with a single button click"
    - "User can test a prompt with sample text and see a preview response"
    - "User can enable/disable the quick prompts feature via a toggle"
    - "Custom prompts support {{selection}} template variable"
  artifacts:
    - path: "src/components/settings/QuickPromptSettings.tsx"
      provides: "Full CRUD settings component with DnD reorder, icon picker, test button"
      exports: ["default"]
    - path: "entrypoints/popup/App.tsx"
      provides: "Popup with Quick Prompts section in settings tab"
      contains: "QuickPromptSettings"
  key_links:
    - from: "src/components/settings/QuickPromptSettings.tsx"
      to: "src/store/index.ts"
      via: "useStore for quick prompt CRUD"
      pattern: "useStore"
    - from: "src/components/settings/QuickPromptSettings.tsx"
      to: "src/store/quickPromptsSlice.ts"
      via: "imports DEFAULT_QUICK_PROMPTS for reset"
      pattern: "DEFAULT_QUICK_PROMPTS"
    - from: "entrypoints/popup/App.tsx"
      to: "src/components/settings/QuickPromptSettings.tsx"
      via: "renders QuickPromptSettings"
      pattern: "QuickPromptSettings"
---

<objective>
Build the settings UI for configuring quick prompt actions in the popup. Includes full CRUD, drag-and-drop reordering, icon picker, test button, enable/disable toggle, and reset-to-defaults.

Purpose: Users need to customize which quick prompt actions appear in the selection tooltip. Without this settings UI, users are locked into the 4 defaults with no way to add, remove, or reorder actions.

Output: QuickPromptSettings component integrated into the popup settings tab.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-text-selection/21-RESEARCH.md
@.planning/phases/21-text-selection/21-01-SUMMARY.md

@entrypoints/popup/App.tsx
@src/store/types.ts
@src/store/quickPromptsSlice.ts
@src/components/settings/ApiKeySettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install DnD kit and create QuickPromptSettings component</name>
  <files>src/components/settings/QuickPromptSettings.tsx</files>
  <action>
**0. Install @dnd-kit packages:**

Run `npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities` to add drag-and-drop support.

**1. Create `src/components/settings/QuickPromptSettings.tsx`:**

This is a single comprehensive settings component. Follow the existing settings component patterns (e.g., `ApiKeySettings.tsx`, `BlurSettings.tsx`) for styling conventions.

**Structure overview:**

```
QuickPromptSettings
├── Enable/Disable toggle (top)
├── Action list (sortable via @dnd-kit)
│   └── For each action:
│       ├── Grab handle (drag indicator)
│       ├── Icon (emoji) + Label
│       ├── Edit button → opens edit modal/inline form
│       └── Delete button
├── "Add Action" button (disabled if 4 actions exist)
├── "Reset to Defaults" button
└── Add/Edit form (modal or inline expandable)
    ├── Label input
    ├── Icon picker (grid of ~12 emoji icons)
    ├── Prompt template textarea with {{selection}} hint
    └── "Test" button + response preview area
    └── Save / Cancel buttons
```

**Implementation details:**

**a. Enable/Disable toggle:**
- Use `quickPromptsEnabled` from store and `setQuickPromptsEnabled`
- Simple toggle switch (checkbox styled as toggle, matching existing settings patterns)
- When disabled, dim the rest of the component

**b. Sortable list using @dnd-kit:**
```typescript
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';
import { SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
```

Each list item is a `SortableItem` component:
```typescript
function SortableItem({ action, onEdit, onDelete }: SortableItemProps) {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({ id: action.id });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };
  return (
    <div ref={setNodeRef} style={style} className="flex items-center gap-2 rounded border border-gray-200 bg-white px-3 py-2">
      {/* Grab handle */}
      <button {...attributes} {...listeners} className="cursor-grab text-gray-400 hover:text-gray-600">
        <span className="text-sm">&#x2630;</span> {/* Hamburger menu icon as grab handle */}
      </button>
      {/* Icon + Label */}
      <span className="text-base">{ICON_MAP[action.icon] || action.icon}</span>
      <span className="flex-1 text-sm font-medium text-gray-700">{action.label}</span>
      {/* Edit button */}
      <button onClick={() => onEdit(action)} className="text-xs text-blue-600 hover:text-blue-800">Edit</button>
      {/* Delete button */}
      <button onClick={() => onDelete(action.id)} className="text-xs text-red-600 hover:text-red-800">Delete</button>
    </div>
  );
}
```

On `handleDragEnd`:
```typescript
function handleDragEnd(event: DragEndEvent) {
  const { active, over } = event;
  if (active.id !== over?.id) {
    const oldIndex = quickPrompts.findIndex(p => p.id === active.id);
    const newIndex = quickPrompts.findIndex(p => p.id === over!.id);
    const reordered = arrayMove(quickPrompts, oldIndex, newIndex);
    reorderQuickPrompts(reordered.map(p => p.id));
  }
}
```

Import `arrayMove` from `@dnd-kit/sortable`.

**c. Add/Edit form:**
- Controlled form state with `useState` for label, icon, promptTemplate
- Icon picker: grid of ~12 emoji options from `ICON_OPTIONS` (imported from SelectionTooltip.tsx or a shared constants file). Each option is a clickable button showing the emoji, with a blue ring on the selected one.
- Prompt template textarea: include placeholder text showing `{{selection}}` usage. Show a helper text: "Use {{selection}} where the selected text should appear"
- Max 4 enforcement: "Add Action" button is disabled with a tooltip "Maximum 4 actions" if at limit
- Validation: label is required, promptTemplate is required (must contain `{{selection}}` or the template will just be prepended to the selection)

**d. Test button:**
- "Test" button next to Save/Cancel in the form
- Sends a quick prompt request with sample text: "Microservices architecture provides independent deployability and technology heterogeneity, but introduces complexity in distributed data management and inter-service communication."
- Shows the response in a preview area below the form
- Uses `safeSendMessage` to send a `QUICK_PROMPT_REQUEST` to background
- Listens for the response via `chrome.runtime.onMessage` temporarily
- Shows loading state while waiting

**e. Reset to defaults:**
- Button at the bottom: "Reset to Defaults"
- Calls `resetQuickPromptsToDefaults()` from the store
- Confirm with a simple `window.confirm()` dialog

**f. Import ICON_MAP/ICON_OPTIONS:**
Import from the shared location where SelectionTooltip defines them (created in Plan 02). If Plan 02 exports them from `src/overlay/SelectionTooltip.tsx`, import from there. Alternatively, extract to a shared `src/constants/quickPromptIcons.ts` file to avoid importing from overlay in popup context.

RECOMMENDATION: Create `src/constants/quickPromptIcons.ts` with `ICON_MAP` and `ICON_OPTIONS` exports. Both SelectionTooltip.tsx and QuickPromptSettings.tsx import from there.

**g. Styling:**
- Match existing popup settings styling (gray borders, rounded corners, proper spacing)
- Use Tailwind classes consistent with other settings components
- Disabled state uses `opacity-50` and `pointer-events-none`
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile. Run `npx eslint src/components/settings/QuickPromptSettings.tsx` -- should pass. Verify @dnd-kit packages are in package.json.
  </verify>
  <done>
QuickPromptSettings component exists with full CRUD for quick prompt actions, drag-and-drop reordering, icon picker, test button with preview, enable/disable toggle, and reset-to-defaults button. All icons are from a shared constant file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate QuickPromptSettings into popup App</name>
  <files>
    entrypoints/popup/App.tsx
    src/constants/quickPromptIcons.ts
  </files>
  <action>
**1. Create `src/constants/quickPromptIcons.ts` (if not already created in Task 1):**

```typescript
export const ICON_MAP: Record<string, string> = {
  lightbulb: '\u{1F4A1}',
  expand: '\u{1F50D}',
  compress: '\u{1F4DD}',
  scales: '\u{2696}\u{FE0F}',
  brain: '\u{1F9E0}',
  rocket: '\u{1F680}',
  check: '\u{2705}',
  warning: '\u{26A0}\u{FE0F}',
  star: '\u{2B50}',
  wrench: '\u{1F527}',
  book: '\u{1F4DA}',
  chat: '\u{1F4AC}',
};

export const ICON_OPTIONS = Object.entries(ICON_MAP).map(([key, emoji]) => ({
  key,
  emoji,
  label: key.charAt(0).toUpperCase() + key.slice(1),
}));
```

**2. Modify `entrypoints/popup/App.tsx`:**

- Import `QuickPromptSettings` component
- Add the Quick Prompts section to the settings tab, between the "Personalization" section and the "Hotkeys" section:

```tsx
{/* Quick Prompts Section */}
<section>
  <h2 className="mb-3 text-sm font-semibold text-gray-900">Quick Prompts</h2>
  <QuickPromptSettings />
</section>
```

This placement makes sense because:
- It's after Personalization (file uploads) which is about context
- It's before Hotkeys which is about interaction
- Quick Prompts is about customizing AI interaction behavior

**3. Update SelectionTooltip.tsx (if needed) to import from shared constants:**

If Plan 02's Task 1 defined ICON_MAP inline in SelectionTooltip.tsx, update it to import from `src/constants/quickPromptIcons.ts` instead. This avoids duplication.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile. Run `npx eslint entrypoints/popup/App.tsx src/constants/quickPromptIcons.ts` -- should pass. Open the popup and verify the "Quick Prompts" section appears in the Settings tab with the correct UI.
  </verify>
  <done>
QuickPromptSettings is integrated into the popup settings tab. Icon constants are shared between overlay tooltip and settings UI. Users can configure quick prompts through the popup.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx eslint .` passes on modified files
3. @dnd-kit packages are in package.json dependencies
4. QuickPromptSettings renders in the popup settings tab
5. Drag-and-drop reordering works (visual verification)
6. Add/Edit form enforces max 4 actions
7. Test button sends a real request and shows preview
8. Reset to defaults restores the 4 original actions
9. Enable/disable toggle persists across popup close/reopen
</verification>

<success_criteria>
- QuickPromptSettings component renders in popup settings tab with full CRUD functionality
- Drag-and-drop reordering works with visible grab handles
- Icon picker shows ~12 emoji options in a grid
- Test button sends prompt with sample text and shows response preview
- Reset to defaults restores Explain, Elaborate, Summarize, Counter-argument
- Enable/disable toggle controls whether the selection tooltip appears
- All configurations persist via Zustand store (chrome.storage)
</success_criteria>

<output>
After completion, create `.planning/phases/21-text-selection/21-03-SUMMARY.md`
</output>
