---
phase: 15-markdown-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/markdown/MarkdownRenderer.tsx
  - src/components/markdown/CodeBlock.tsx
  - src/components/markdown/MemoizedMarkdown.tsx
  - src/assets/app.css
autonomous: true

must_haves:
  truths:
    - "MarkdownRenderer converts a markdown string into styled React elements with headers, bold, italic, lists, blockquotes, tables, and links"
    - "Code blocks render with syntax highlighting colors, a language label, and a copy-to-clipboard button"
    - "MemoizedMarkdown splits content into blocks and memoizes completed blocks so only the last block re-renders during streaming"
    - "Highlight.js dark theme CSS is imported in app.css for Shadow DOM injection via WXT cssInjectionMode"
  artifacts:
    - path: "src/components/markdown/MarkdownRenderer.tsx"
      provides: "react-markdown wrapper with Tailwind component overrides and rehype-highlight plugin"
      exports: ["MarkdownRenderer"]
    - path: "src/components/markdown/CodeBlock.tsx"
      provides: "Code block component with language label, copy button, inline code styling"
      exports: ["CodeBlock"]
    - path: "src/components/markdown/MemoizedMarkdown.tsx"
      provides: "Block-level memoization wrapper using marked.lexer() for streaming performance"
      exports: ["MemoizedMarkdown"]
    - path: "src/assets/app.css"
      provides: "Highlight.js github-dark theme CSS for syntax highlighting in Shadow DOM"
      contains: "hljs"
  key_links:
    - from: "src/components/markdown/MarkdownRenderer.tsx"
      to: "src/components/markdown/CodeBlock.tsx"
      via: "components prop maps code element to CodeBlock"
      pattern: "code:\\s*CodeBlock"
    - from: "src/components/markdown/MemoizedMarkdown.tsx"
      to: "src/components/markdown/MarkdownRenderer.tsx"
      via: "MemoizedBlock renders each block with MarkdownRenderer"
      pattern: "MarkdownRenderer"
    - from: "src/assets/app.css"
      to: "rehype-highlight output"
      via: "hljs-* CSS classes style syntax-highlighted spans"
      pattern: "\\.hljs"
---

<objective>
Create the markdown rendering component system: MarkdownRenderer with Tailwind component overrides for Shadow DOM, CodeBlock with syntax highlighting and copy button, MemoizedMarkdown for streaming performance, and highlight.js theme CSS.

Purpose: Build the complete markdown subsystem that Phase 15 Plan 02 will wire into the existing ResponsePanel. All markdown rendering, code formatting, and streaming memoization logic lives in these components.

Output: Three React components in `src/components/markdown/` and highlight.js CSS in `app.css`, ready for integration.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-markdown-rendering/15-RESEARCH.md
@src/assets/app.css
@src/overlay/ResponsePanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create CodeBlock component</name>
  <files>
    package.json
    src/components/markdown/CodeBlock.tsx
  </files>
  <action>
    Install required dependencies:
    ```bash
    npm install react-markdown remark-gfm rehype-highlight marked
    npm install -D @types/marked
    ```

    Create `src/components/markdown/CodeBlock.tsx` — the custom code block component used by react-markdown's `components` prop:

    - Accept `children`, `className`, and rest props from react-markdown
    - Detect block vs inline code: block code has `className` matching `/language-(\w+)/` (set by rehype-highlight)
    - **Inline code** (`!isBlock`): render `<code>` with `bg-white/10 rounded px-1 py-0.5 text-xs font-mono text-green-300`
    - **Block code** (`isBlock`): render a wrapper `<div>` with:
      - Header bar: `flex items-center justify-between px-3 py-1 border-b border-white/10 text-xs`
        - Left: language label (`text-white/50 uppercase tracking-wider`) extracted from className
        - Right: copy button (`text-white/40 hover:text-white/80 transition-colors`) using `navigator.clipboard.writeText()`
      - Code area: `<pre className="overflow-x-auto p-3 text-xs leading-relaxed max-h-60 overflow-y-auto">` wrapping `<code className={className}>`
      - Outer div: `relative rounded bg-black/40 mb-2 group`
    - Copy button: useState for `copied` state, show "Copied" for 2 seconds after click, then revert to "Copy"
    - Extract code text with `String(children).replace(/\n$/, '')` for clipboard
    - Use `useCallback` for the copy handler
    - Include a fallback for clipboard API failure (console.warn, no crash)

    Type the props interface explicitly:
    ```typescript
    interface CodeBlockProps {
      children: React.ReactNode;
      className?: string;
      node?: unknown;
      [key: string]: unknown;
    }
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors in CodeBlock.tsx.
    Verify file exists: `ls src/components/markdown/CodeBlock.tsx`
  </verify>
  <done>
    CodeBlock component exists with: inline code styling, block code with language label + copy button + syntax highlighting container, proper TypeScript types, clipboard API integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MarkdownRenderer, MemoizedMarkdown, and highlight.js theme CSS</name>
  <files>
    src/components/markdown/MarkdownRenderer.tsx
    src/components/markdown/MemoizedMarkdown.tsx
    src/assets/app.css
  </files>
  <action>
    **MarkdownRenderer.tsx** — Main react-markdown wrapper with Tailwind component overrides:

    - Import `Markdown` from `react-markdown` (default export), `remarkGfm` from `remark-gfm`, `rehypeHighlight` from `rehype-highlight`
    - Import `CodeBlock` from `./CodeBlock`
    - Define a `components` object mapping EVERY markdown element to a React component with explicit Tailwind utility classes. Use the exact class mappings from the research (Pattern 1 in 15-RESEARCH.md):
      - `h1`: `text-lg font-bold text-white/90 mb-2`
      - `h2`: `text-base font-semibold text-white/85 mb-1.5`
      - `h3`: `text-sm font-semibold text-white/80 mb-1`
      - `p`: `text-sm text-white/85 mb-1.5 leading-relaxed`
      - `strong`: `font-semibold text-white/95`
      - `em`: `italic text-white/80`
      - `ul`: `list-disc list-inside text-sm mb-1.5 space-y-0.5`
      - `ol`: `list-decimal list-inside text-sm mb-1.5 space-y-0.5`
      - `li`: `text-white/85`
      - `blockquote`: `border-l-2 border-white/30 pl-3 text-sm text-white/70 italic mb-1.5`
      - `a`: `text-blue-300 underline hover:text-blue-200` with `target="_blank" rel="noopener noreferrer"`
      - `hr`: `border-white/20 my-2`
      - `table`: wrapped in `overflow-x-auto mb-2` div, table gets `text-xs border-collapse w-full`
      - `th`: `border border-white/20 px-2 py-1 text-left font-medium text-white/90 bg-white/5`
      - `td`: `border border-white/20 px-2 py-1 text-white/80`
      - `pre`: renders `<>{children}</>` (passthrough — CodeBlock handles the wrapping)
      - `code`: `CodeBlock` component
    - Export `MarkdownRenderer` component accepting `{ content: string }` props
    - Render: `<Markdown remarkPlugins={[remarkGfm]} rehypePlugins={[rehypeHighlight]} components={components}>{content}</Markdown>`
    - Define the `components` object OUTSIDE the component function (it's static, no closures needed) to avoid recreation on every render

    **MemoizedMarkdown.tsx** — Block-level memoization for streaming:

    - Import `memo`, `useMemo` from React
    - Import `marked` from `marked` (for `marked.lexer()` only — NOT for rendering)
    - Import `MarkdownRenderer` from `./MarkdownRenderer`
    - Create `MemoizedBlock` — a `memo()`-wrapped component that renders `<MarkdownRenderer content={content} />`. Custom comparator: `(prev, next) => prev.content === next.content`
    - Create `MemoizedMarkdown` component accepting `{ content: string }`:
      - Use `useMemo` to split content into blocks: `marked.lexer(content).map(token => token.raw)`
      - Render each block with `<MemoizedBlock key={i} content={block} />`
    - Export `MemoizedMarkdown`

    **app.css** — Add highlight.js dark theme:

    - After the existing `@import 'tailwindcss';` line, add: `@import 'highlight.js/styles/github-dark.min.css';`
    - If the `@import` doesn't resolve through Vite (test with `npm run dev`), fall back to inlining the essential hljs classes directly:
      ```css
      .hljs { color: #c9d1d9; background: transparent; }
      .hljs-keyword { color: #ff7b72; }
      .hljs-string { color: #a5d6ff; }
      .hljs-comment { color: #8b949e; font-style: italic; }
      .hljs-number { color: #79c0ff; }
      .hljs-title { color: #d2a8ff; }
      .hljs-built_in { color: #ffa657; }
      .hljs-literal { color: #79c0ff; }
      .hljs-type { color: #ffa657; }
      .hljs-params { color: #c9d1d9; }
      .hljs-meta { color: #8b949e; }
      .hljs-attr { color: #79c0ff; }
      .hljs-variable { color: #ffa657; }
      .hljs-function { color: #d2a8ff; }
      .hljs-selector-class { color: #7ee787; }
      .hljs-selector-tag { color: #7ee787; }
      .hljs-template-variable { color: #ffa657; }
      .hljs-addition { color: #aff5b4; background: #033a16; }
      .hljs-deletion { color: #ffdcd7; background: #67060c; }
      ```
    - Set `.hljs { background: transparent; }` to ensure the code block background comes from CodeBlock's `bg-black/40`, not highlight.js's default background
    - Do NOT modify any existing CSS in app.css — only append new content
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors in any file.
    Run `npm run dev` — verify the build succeeds with no CSS import errors.
    Verify all three files exist:
    ```bash
    ls src/components/markdown/MarkdownRenderer.tsx
    ls src/components/markdown/MemoizedMarkdown.tsx
    ```
    Check that app.css contains hljs styles: `grep hljs src/assets/app.css`
  </verify>
  <done>
    MarkdownRenderer component renders markdown with Tailwind-styled elements via react-markdown components prop. MemoizedMarkdown splits content into blocks via marked.lexer() and memoizes each. Highlight.js github-dark theme CSS is injected into app.css for Shadow DOM compatibility. All three components compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run dev` builds successfully with no CSS import failures
3. All files exist: `src/components/markdown/CodeBlock.tsx`, `src/components/markdown/MarkdownRenderer.tsx`, `src/components/markdown/MemoizedMarkdown.tsx`
4. `app.css` contains highlight.js theme (either via `@import` or inlined classes)
5. `package.json` includes `react-markdown`, `remark-gfm`, `rehype-highlight`, `marked` as dependencies
</verification>

<success_criteria>
- react-markdown, remark-gfm, rehype-highlight, and marked are installed
- MarkdownRenderer wraps react-markdown with Tailwind component overrides for all markdown elements
- CodeBlock handles both inline and block code with language label, copy button, and syntax highlighting
- MemoizedMarkdown splits markdown into blocks and memoizes completed blocks
- Highlight.js CSS is available inside Shadow DOM via app.css
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/15-markdown-rendering/15-01-SUMMARY.md`
</output>
