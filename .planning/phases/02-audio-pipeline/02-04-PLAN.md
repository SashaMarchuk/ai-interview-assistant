---
phase: 02-audio-pipeline
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - entrypoints/popup/App.tsx
  - entrypoints/offscreen/main.ts
autonomous: false

must_haves:
  truths:
    - "User clicks Start button and capture begins"
    - "User can hear tab audio while capturing"
    - "Console shows PCM chunks being generated"
    - "User clicks Stop and resources are released"
  artifacts:
    - path: "entrypoints/popup/App.tsx"
      provides: "Start/Stop capture buttons"
      contains: "START_CAPTURE"
  key_links:
    - from: "entrypoints/popup/App.tsx"
      to: "entrypoints/background.ts"
      via: "START_CAPTURE message on button click"
      pattern: "type.*START_CAPTURE"
---

<objective>
Add Start/Stop buttons to the Popup UI and verify the complete audio capture flow works end-to-end.

Purpose: Complete the AUD-05 requirement (user gesture from popup) and verify all Phase 2 success criteria.
Output: Updated Popup with capture controls, verified end-to-end audio flow.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-audio-pipeline/02-RESEARCH.md
@.planning/phases/02-audio-pipeline/02-02-SUMMARY.md
@.planning/phases/02-audio-pipeline/02-03-SUMMARY.md

@src/types/messages.ts
@entrypoints/popup/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Start/Stop capture controls to Popup</name>
  <files>entrypoints/popup/App.tsx</files>
  <action>
Replace the test buttons in App.tsx with actual capture controls:

1. Add state:
   - const [isCapturing, setIsCapturing] = useState(false)
   - const [captureStatus, setCaptureStatus] = useState<string>('Idle')
   - const [tabChunks, setTabChunks] = useState(0)
   - const [micChunks, setMicChunks] = useState(0)

2. Create handleStartCapture async function:
   - Set captureStatus to 'Starting...'
   - Send START_CAPTURE message to background
   - Send START_MIC_CAPTURE message to background (separate call)
   - On success, set isCapturing to true, status to 'Capturing'
   - On error, set status to error message

3. Create handleStopCapture async function:
   - Set captureStatus to 'Stopping...'
   - Send STOP_CAPTURE message
   - Send STOP_MIC_CAPTURE message
   - Set isCapturing to false, status to 'Idle'
   - Reset chunk counters

4. Update UI:
   - Keep Service Worker test section (useful for debugging)
   - Remove or minimize Offscreen Document test section
   - Add new "Audio Capture" section:
     - Status display: captureStatus
     - Tab Chunks: {tabChunks} count
     - Mic Chunks: {micChunks} count
     - Start button (disabled when capturing): green, calls handleStartCapture
     - Stop button (disabled when not capturing): red, calls handleStopCapture

5. Add message listener for chunk counts (optional enhancement):
   - Listen for TAB_AUDIO_CHUNK and MIC_AUDIO_CHUNK from background
   - Increment counters to show activity
   - Note: This requires bidirectional messaging setup

For simplicity, chunk counting can be verified via console logs in background.ts rather than popup display. The key is Start/Stop buttons work.

Style consistently with existing Tailwind classes (border rounded p-3, etc.)
  </action>
  <verify>
TypeScript compiles:
```bash
cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension && npx tsc --noEmit
```
Build succeeds:
```bash
cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension && npm run build
```
  </verify>
  <done>Popup has Start/Stop buttons, sends capture messages on click</done>
</task>

<task type="auto">
  <name>Task 2: Add cleanup on extension unload</name>
  <files>entrypoints/offscreen/main.ts</files>
  <action>
Ensure clean resource release when extension reloads or unloads:

1. Add window 'beforeunload' event listener:
   - Call stopTabCapture() if tabStream exists
   - Call stopMicCapture() if micStream exists
   - Log cleanup for debugging

2. Add chrome.runtime.onSuspend listener (if available in offscreen context):
   - Same cleanup logic
   - Note: May not fire in offscreen documents, beforeunload is backup

3. In stopTabCapture and stopMicCapture:
   - Add null checks before operations
   - Wrap in try/catch to prevent errors blocking cleanup
   - Log successful cleanup

This prevents memory leaks and orphaned audio streams when:
- User reloads extension
- User disables extension
- Extension updates
  </action>
  <verify>
TypeScript compiles:
```bash
cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension && npx tsc --noEmit
```
  </verify>
  <done>Resources properly cleaned up on unload, no memory leaks</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete audio capture pipeline: Tab audio captured with passthrough, microphone captured separately, PCM chunks flowing through AudioWorklet</what-built>
  <how-to-verify>
1. Build and load extension:
   ```
   cd /Users/sasha-marchuk/Work/Ai-Interview-Assistant-Chrome-Extension
   npm run build
   ```
2. Go to chrome://extensions, remove old version, "Load unpacked" from .output/chrome-mv3/

3. Open a tab with audio (YouTube, Google Meet, any video)

4. Click extension icon to open popup

5. Click "Start" button

6. Verify in Service Worker console (chrome://extensions > Details > service worker):
   - "TAB_AUDIO_CHUNK" messages appearing with timestamps
   - Check for PCM data (ArrayBuffer logged)

7. Verify you can STILL HEAR the tab audio (passthrough working)

8. If microphone permission needed:
   - Go to chrome://extensions
   - Find AI Interview Assistant
   - Click "Details" then "Extension options" or site settings
   - Grant microphone permission
   - Retry Start

9. Verify microphone capture (MIC_AUDIO_CHUNK in console)

10. Click "Stop" button

11. Verify:
    - Audio chunks stop appearing
    - No errors in console
    - Tab audio continues normally (wasn't muted)

12. Reload extension and verify no orphaned processes
  </how-to-verify>
  <resume-signal>Type "verified" if all Phase 2 success criteria pass, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Popup has Start/Stop buttons
4. Human verification confirms:
   - Tab audio capture works
   - Audio remains audible (passthrough)
   - Microphone capture works
   - PCM chunks logged in console
   - Stop releases resources cleanly
</verification>

<success_criteria>
All Phase 2 success criteria from ROADMAP.md:
1. User can click "Start" button in popup and tab audio capture begins
2. User continues to hear tab audio normally (no muting occurs)
3. User's microphone is captured as a separate audio stream
4. Console logs show PCM audio chunks being generated at 16kHz
5. Stopping capture releases all audio resources cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-audio-pipeline/02-04-SUMMARY.md`
</output>
