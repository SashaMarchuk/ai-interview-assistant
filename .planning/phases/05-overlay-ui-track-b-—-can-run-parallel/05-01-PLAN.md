---
phase: 05-overlay-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/transcript.ts
  - src/overlay/hooks/useOverlayPosition.ts
  - src/overlay/hooks/useAutoScroll.ts
  - src/assets/app.css
autonomous: true

must_haves:
  truths:
    - "react-rnd and use-chrome-storage are installed as dependencies"
    - "TranscriptEntry and LLMResponse types are defined and exported"
    - "useOverlayPosition hook reads/writes position and size to chrome.storage.local"
    - "useAutoScroll hook scrolls container to bottom when dependency changes"
    - "Tailwind v4 CSS has Shadow DOM compatibility fixes"
  artifacts:
    - path: "src/types/transcript.ts"
      provides: "TranscriptEntry, LLMResponse, OverlayState interfaces"
      exports: ["TranscriptEntry", "LLMResponse", "OverlayState", "MOCK_TRANSCRIPT", "MOCK_RESPONSE"]
    - path: "src/overlay/hooks/useOverlayPosition.ts"
      provides: "Hook for overlay position/size persistence"
      exports: ["useOverlayPosition"]
    - path: "src/overlay/hooks/useAutoScroll.ts"
      provides: "Hook for auto-scrolling to bottom"
      exports: ["useAutoScroll"]
  key_links:
    - from: "src/overlay/hooks/useOverlayPosition.ts"
      to: "chrome.storage.local"
      via: "use-chrome-storage createChromeStorageStateHookLocal"
      pattern: "createChromeStorageStateHookLocal"
---

<objective>
Install dependencies and create foundational types and hooks for overlay functionality.

Purpose: Establish the building blocks (types, persistence, auto-scroll) that subsequent plans will compose into the full overlay UI.

Output: Installed react-rnd and use-chrome-storage, transcript/response types, position persistence hook, auto-scroll hook, and Tailwind Shadow DOM fixes.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-overlay-ui-track-b-—-can-run-parallel/05-RESEARCH.md

# Existing files to reference
@package.json
@src/assets/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-rnd and use-chrome-storage dependencies</name>
  <files>package.json</files>
  <action>
Run npm install for required dependencies:
```bash
npm install react-rnd use-chrome-storage
```

This adds:
- react-rnd (^10.5.2) - Combined drag and resize functionality
- use-chrome-storage (^1.x) - React hooks for chrome.storage API

Verify package.json is updated with new dependencies.
  </action>
  <verify>
Run `npm ls react-rnd use-chrome-storage` and confirm both packages are listed.
Run `npm run build` and confirm no TypeScript errors.
  </verify>
  <done>
package.json contains react-rnd and use-chrome-storage as dependencies.
Project builds successfully with new dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create transcript and response types with mock data</name>
  <files>src/types/transcript.ts</files>
  <action>
Create `src/types/transcript.ts` with TypeScript interfaces for overlay data:

```typescript
// Transcript entry from STT service
export interface TranscriptEntry {
  id: string;
  speaker: string;           // "Interviewer", "You", or detected name
  text: string;
  timestamp: number;         // Unix timestamp ms
  isFinal: boolean;          // false for interim results
  confidence?: number;       // 0-1 confidence score (optional)
}

// LLM response structure
export interface LLMResponse {
  id: string;
  questionId: string;        // Links to triggering transcript
  fastHint: string | null;   // Quick 1-2 sentence hint
  fullAnswer: string | null; // Complete detailed answer
  status: 'pending' | 'streaming' | 'complete' | 'error';
  error?: string;
}

// Overlay position and size state for persistence
export interface OverlayState {
  x: number;
  y: number;
  width: number;
  height: number;
  isMinimized: boolean;
}

// Default overlay state for first-time users
export const DEFAULT_OVERLAY_STATE: OverlayState = {
  x: -1,  // -1 signals "use calculated default" (bottom-right)
  y: -1,
  width: 340,
  height: 400,
  isMinimized: false,
};

// Mock data for development - simulates real transcript
export const MOCK_TRANSCRIPT: TranscriptEntry[] = [
  {
    id: 'mock-1',
    speaker: 'Interviewer',
    text: 'Can you explain the difference between var, let, and const in JavaScript?',
    timestamp: Date.now() - 30000,
    isFinal: true,
  },
  {
    id: 'mock-2',
    speaker: 'You',
    text: 'Sure, I\'d be happy to explain the differences...',
    timestamp: Date.now() - 25000,
    isFinal: true,
  },
  {
    id: 'mock-3',
    speaker: 'Interviewer',
    text: 'Great, and how does hoisting work with each of these?',
    timestamp: Date.now() - 10000,
    isFinal: true,
  },
];

// Mock LLM response for development
export const MOCK_RESPONSE: LLMResponse = {
  id: 'mock-resp-1',
  questionId: 'mock-3',
  fastHint: 'var is hoisted and initialized to undefined. let/const are hoisted but not initialized (TDZ).',
  fullAnswer: 'All three declarations are hoisted, but they behave differently. var is hoisted and initialized to undefined, so you can reference it before declaration. let and const are hoisted but remain in the "Temporal Dead Zone" (TDZ) until their declaration line, throwing ReferenceError if accessed early. This is why let/const are considered safer - they catch bugs where you accidentally use a variable before it\'s defined.',
  status: 'complete',
};
```

Important: Use explicit types, no `any`. Include JSDoc comments for complex fields.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Import types in a test file to confirm exports work.
  </verify>
  <done>
src/types/transcript.ts exists with TranscriptEntry, LLMResponse, OverlayState interfaces.
Mock data constants are exported for development use.
TypeScript compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create overlay position persistence and auto-scroll hooks</name>
  <files>src/overlay/hooks/useOverlayPosition.ts, src/overlay/hooks/useAutoScroll.ts</files>
  <action>
Create `src/overlay/hooks/useOverlayPosition.ts`:

```typescript
import { createChromeStorageStateHookLocal } from 'use-chrome-storage';
import { DEFAULT_OVERLAY_STATE, type OverlayState } from '../../types/transcript';

const STORAGE_KEY = 'ai-interview-overlay-state';

// Create reusable hook for overlay position/size
const useOverlayStateStorage = createChromeStorageStateHookLocal<OverlayState>(
  STORAGE_KEY,
  DEFAULT_OVERLAY_STATE
);

/**
 * Hook for managing overlay position, size, and minimize state.
 * Persists to chrome.storage.local for session persistence.
 *
 * Returns:
 * - state: Current overlay position/size/minimize state
 * - setState: Function to update state (merges with existing)
 * - isLoaded: Boolean indicating if initial load from storage is complete
 */
export function useOverlayPosition() {
  const [state, setState, isPersistent, error, isLoaded] = useOverlayStateStorage();

  // Calculate actual position (handle -1 default)
  const getPosition = () => {
    if (state.x === -1 || state.y === -1) {
      // First time: position at bottom-right
      return {
        x: window.innerWidth - state.width - 20,
        y: window.innerHeight - state.height - 20,
      };
    }
    return { x: state.x, y: state.y };
  };

  const setPosition = (pos: { x: number; y: number }) => {
    setState((prev) => ({ ...prev, x: pos.x, y: pos.y }));
  };

  const setSize = (size: { width: number; height: number }) => {
    setState((prev) => ({ ...prev, width: size.width, height: size.height }));
  };

  const setMinimized = (isMinimized: boolean) => {
    setState((prev) => ({ ...prev, isMinimized }));
  };

  return {
    position: getPosition(),
    size: { width: state.width, height: state.height },
    isMinimized: state.isMinimized,
    isLoaded,
    setPosition,
    setSize,
    setMinimized,
    // Raw state access for advanced use
    rawState: state,
    setRawState: setState,
  };
}
```

Create `src/overlay/hooks/useAutoScroll.ts`:

```typescript
import { useRef, useEffect } from 'react';

/**
 * Hook that auto-scrolls a container to bottom when dependency changes.
 * Returns a ref to attach to an anchor element at the bottom of scrollable content.
 *
 * Usage:
 * ```tsx
 * const bottomRef = useAutoScroll(items.length);
 * return (
 *   <div className="overflow-y-auto">
 *     {items.map(...)}
 *     <div ref={bottomRef} />
 *   </div>
 * );
 * ```
 */
export function useAutoScroll<T>(dependency: T) {
  const bottomRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    // Smooth scroll to bottom anchor when dependency changes
    bottomRef.current?.scrollIntoView({
      behavior: 'smooth',
      block: 'end',
      inline: 'nearest'
    });
  }, [dependency]);

  return bottomRef;
}
```

Create directory structure first: `mkdir -p src/overlay/hooks`

Note: Use relative imports (../../types/transcript) to avoid path alias issues in WXT entrypoints.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Confirm files exist at correct paths.
  </verify>
  <done>
src/overlay/hooks/useOverlayPosition.ts exports useOverlayPosition hook.
src/overlay/hooks/useAutoScroll.ts exports useAutoScroll hook.
Both hooks compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add Tailwind v4 Shadow DOM compatibility fixes to CSS</name>
  <files>src/assets/app.css</files>
  <action>
Update `src/assets/app.css` to add Shadow DOM compatibility for Tailwind v4:

```css
@import "tailwindcss";

/*
 * Tailwind v4 Shadow DOM Compatibility
 *
 * Problem: Tailwind v4 uses @property CSS declarations for variable defaults,
 * but @property has no effect inside Shadow DOM.
 *
 * Solution: Provide explicit fallback values using @theme inline and :host selector.
 * This ensures spacing, colors, and effects work correctly in Shadow DOM.
 */

@theme inline {
  /* Override rem-based spacing with px values for Shadow DOM */
  --spacing-0: 0;
  --spacing-0-5: 2px;
  --spacing-1: 4px;
  --spacing-1-5: 6px;
  --spacing-2: 8px;
  --spacing-2-5: 10px;
  --spacing-3: 12px;
  --spacing-3-5: 14px;
  --spacing-4: 16px;
  --spacing-5: 20px;
  --spacing-6: 24px;
  --spacing-7: 28px;
  --spacing-8: 32px;
  --spacing-9: 36px;
  --spacing-10: 40px;
  --spacing-11: 44px;
  --spacing-12: 48px;
  --spacing-14: 56px;
  --spacing-16: 64px;
  --spacing-20: 80px;

  /* Text sizes in px for Shadow DOM */
  --text-xs: 12px;
  --text-sm: 14px;
  --text-base: 16px;
  --text-lg: 18px;
  --text-xl: 20px;
  --text-2xl: 24px;
}

/* Shadow DOM fallbacks for @property-dependent features */
:host {
  /* Shadow/ring effect fallbacks */
  --tw-shadow: 0 0 #0000;
  --tw-shadow-colored: 0 0 #0000;
  --tw-ring-shadow: 0 0 #0000;
  --tw-ring-offset-shadow: 0 0 #0000;

  /* Border style fallback */
  --tw-border-style: solid;

  /* Transform fallbacks */
  --tw-translate-x: 0;
  --tw-translate-y: 0;
  --tw-rotate: 0;
  --tw-scale-x: 1;
  --tw-scale-y: 1;

  /* Backdrop filter fallbacks */
  --tw-backdrop-blur: ;
  --tw-backdrop-brightness: ;
  --tw-backdrop-contrast: ;
  --tw-backdrop-saturate: ;
}

/* Ensure overlay container styles work in Shadow DOM */
.overlay-container {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
```

This fixes the known Tailwind v4 + Shadow DOM compatibility issues identified in research.
  </action>
  <verify>
Run `npm run build` and confirm build succeeds.
Inspect the built CSS to verify @theme values are present.
  </verify>
  <done>
src/assets/app.css contains Shadow DOM compatibility fixes.
@theme inline block has px-based spacing values.
:host selector has fallback CSS variable definitions.
Build succeeds without CSS errors.
  </done>
</task>

</tasks>

<verification>
1. Run `npm ls react-rnd use-chrome-storage` - both packages listed
2. Run `npx tsc --noEmit` - no TypeScript errors
3. Run `npm run build` - build succeeds
4. Confirm files exist:
   - src/types/transcript.ts
   - src/overlay/hooks/useOverlayPosition.ts
   - src/overlay/hooks/useAutoScroll.ts
   - src/assets/app.css (updated)
</verification>

<success_criteria>
- Dependencies installed: react-rnd, use-chrome-storage in package.json
- Types defined: TranscriptEntry, LLMResponse, OverlayState with mock data
- Hooks created: useOverlayPosition (persists to chrome.storage), useAutoScroll (scrolls to bottom)
- CSS fixed: Tailwind v4 Shadow DOM compatibility with px-based spacing and :host fallbacks
- Build passes: `npm run build` completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-overlay-ui-track-b-—-can-run-parallel/05-01-SUMMARY.md`
</output>
