---
phase: 08-openai-provider-support
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/types.ts
  - src/store/settingsSlice.ts
  - src/components/settings/ApiKeySettings.tsx
  - src/components/settings/ModelSettings.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter OpenAI API key in settings"
    - "OpenAI key persists across browser sessions"
    - "Model selection UI shows provider indicator"
  artifacts:
    - path: "src/store/types.ts"
      provides: "Updated ApiKeyProvider type with 'openAI'"
      contains: "'openAI'"
    - path: "src/store/settingsSlice.ts"
      provides: "OpenAI key in default settings and state"
      contains: "openAI:"
    - path: "src/components/settings/ApiKeySettings.tsx"
      provides: "OpenAI API key input field"
      contains: "openAI"
    - path: "src/components/settings/ModelSettings.tsx"
      provides: "Provider-aware model options"
      contains: "provider"
  key_links:
    - from: "src/components/settings/ApiKeySettings.tsx"
      to: "src/store"
      via: "useStore hook"
      pattern: "useStore.*apiKeys"
    - from: "src/store/settingsSlice.ts"
      to: "chrome.storage"
      via: "chromeStorage adapter"
      pattern: "apiKeys.*openAI"
---

<objective>
Update the store and settings UI to support OpenAI as an additional API key provider with provider-aware model selection.

Purpose: Enable users to configure OpenAI API keys and see appropriate models for their configured provider(s). This is independent of the provider abstraction layer (Plan 01) and can run in parallel.

Output: Updated store types, settings slice, and settings UI components ready for provider integration
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-openai-provider-support/08-RESEARCH.md

# Existing store and UI files to modify
@src/store/types.ts
@src/store/settingsSlice.ts
@src/components/settings/ApiKeySettings.tsx
@src/components/settings/ModelSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update store types and settings slice</name>
  <files>
    src/store/types.ts
    src/store/settingsSlice.ts
  </files>
  <action>
1. Update `src/store/types.ts`:

Change ApiKeyProvider type from:
```typescript
export type ApiKeyProvider = 'elevenLabs' | 'openRouter';
```
To:
```typescript
export type ApiKeyProvider = 'elevenLabs' | 'openRouter' | 'openAI';
```

Update SettingsSlice interface - change apiKeys from:
```typescript
apiKeys: {
  elevenLabs: string;
  openRouter: string;
};
```
To:
```typescript
apiKeys: {
  elevenLabs: string;
  openRouter: string;
  openAI: string;
};
```

2. Update `src/store/settingsSlice.ts`:

Update DEFAULT_SETTINGS.apiKeys from:
```typescript
apiKeys: {
  elevenLabs: '',
  openRouter: '',
},
```
To:
```typescript
apiKeys: {
  elevenLabs: '',
  openRouter: '',
  openAI: '',
},
```

The setApiKey action already handles dynamic provider keys via `[provider]: key`, so no action changes needed.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors
Verify store types show openAI in ApiKeyProvider union
  </verify>
  <done>
Store types and settings slice updated with openAI key support, chrome.storage persistence will handle the new field automatically
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ApiKeySettings and ModelSettings UI</name>
  <files>
    src/components/settings/ApiKeySettings.tsx
    src/components/settings/ModelSettings.tsx
  </files>
  <action>
1. Update `src/components/settings/ApiKeySettings.tsx`:

Add OpenAI to API_KEY_FIELDS array:
```typescript
const API_KEY_FIELDS: { provider: ApiKeyProvider; label: string; placeholder: string }[] = [
  {
    provider: 'elevenLabs',
    label: 'ElevenLabs API Key',
    placeholder: 'Enter your ElevenLabs API key',
  },
  {
    provider: 'openRouter',
    label: 'OpenRouter API Key',
    placeholder: 'Enter your OpenRouter API key',
  },
  {
    provider: 'openAI',
    label: 'OpenAI API Key',
    placeholder: 'Enter your OpenAI API key',
  },
];
```

Update showKey initial state to include openAI:
```typescript
const [showKey, setShowKey] = useState<Record<string, boolean>>({
  elevenLabs: false,
  openRouter: false,
  openAI: false,
});
```

2. Update `src/components/settings/ModelSettings.tsx`:

Add provider information to model options and show provider badges:

Replace the static FAST_MODELS and FULL_MODELS with provider-aware models:
```typescript
/** Model option with provider info */
interface ModelOption {
  id: string;
  name: string;
  provider: 'openrouter' | 'openai';
}

/** Fast models for quick hints - low latency, efficient */
const FAST_MODELS: ModelOption[] = [
  // OpenRouter models
  { id: 'google/gemini-flash-1.5', name: 'Gemini Flash 1.5', provider: 'openrouter' },
  { id: 'anthropic/claude-3-haiku', name: 'Claude 3 Haiku', provider: 'openrouter' },
  { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini (via OpenRouter)', provider: 'openrouter' },
  // OpenAI direct models
  { id: 'gpt-4o-mini', name: 'GPT-4o Mini', provider: 'openai' },
  { id: 'gpt-4.1-mini', name: 'GPT-4.1 Mini', provider: 'openai' },
  { id: 'gpt-4.1-nano', name: 'GPT-4.1 Nano', provider: 'openai' },
];

/** Full models for comprehensive answers - higher quality */
const FULL_MODELS: ModelOption[] = [
  // OpenRouter models
  { id: 'anthropic/claude-3-5-sonnet', name: 'Claude 3.5 Sonnet', provider: 'openrouter' },
  { id: 'openai/gpt-4o', name: 'GPT-4o (via OpenRouter)', provider: 'openrouter' },
  { id: 'google/gemini-pro-1.5', name: 'Gemini Pro 1.5', provider: 'openrouter' },
  // OpenAI direct models
  { id: 'gpt-4o', name: 'GPT-4o', provider: 'openai' },
  { id: 'gpt-4.1', name: 'GPT-4.1', provider: 'openai' },
];
```

Update ModelSelect component to:
a) Accept apiKeys prop to filter available models
b) Filter models based on which API keys are configured
c) Show provider indicator in dropdown:

```typescript
interface ModelSelectProps {
  label: string;
  description: string;
  modelType: ModelType;
  options: ModelOption[];
}

function ModelSelect({ label, description, modelType, options }: ModelSelectProps) {
  const models = useStore((state) => state.models);
  const setModel = useStore((state) => state.setModel);
  const apiKeys = useStore((state) => state.apiKeys);

  // Filter models based on configured API keys
  const availableOptions = options.filter((model) => {
    if (model.provider === 'openrouter') return !!apiKeys.openRouter;
    if (model.provider === 'openai') return !!apiKeys.openAI;
    return false;
  });

  // If current selection is not available, don't force change (let user configure keys first)
  const currentValue = models[modelType];
  const isCurrentAvailable = availableOptions.some((m) => m.id === currentValue);

  return (
    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
      <select
        value={currentValue}
        onChange={(e) => setModel(modelType, e.target.value)}
        className={`w-full px-3 py-2 border rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
          !isCurrentAvailable && availableOptions.length > 0 ? 'border-yellow-400' : 'border-gray-300'
        }`}
      >
        {/* Show current value even if not available (grayed out) */}
        {!isCurrentAvailable && (
          <option value={currentValue} disabled className="text-gray-400">
            {currentValue} (requires API key)
          </option>
        )}
        {/* Group by provider */}
        {apiKeys.openAI && (
          <optgroup label="OpenAI">
            {availableOptions
              .filter((m) => m.provider === 'openai')
              .map((model) => (
                <option key={model.id} value={model.id}>
                  {model.name}
                </option>
              ))}
          </optgroup>
        )}
        {apiKeys.openRouter && (
          <optgroup label="OpenRouter">
            {availableOptions
              .filter((m) => m.provider === 'openrouter')
              .map((model) => (
                <option key={model.id} value={model.id}>
                  {model.name}
                </option>
              ))}
          </optgroup>
        )}
      </select>
      <p className="mt-1 text-xs text-gray-500">{description}</p>
      {availableOptions.length === 0 && (
        <p className="mt-1 text-xs text-yellow-600">
          Configure an API key to enable model selection
        </p>
      )}
    </div>
  );
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors
Run `npm run build` - builds successfully
Manually verify: Load extension, open popup, Settings tab shows OpenAI API key field
Manually verify: Model dropdowns group models by provider with optgroup labels
  </verify>
  <done>
API key settings shows OpenAI field, model settings filters and groups models by configured provider
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. ApiKeyProvider type includes 'openAI'
4. Settings slice has openAI in default apiKeys
5. ApiKeySettings.tsx shows three API key fields (ElevenLabs, OpenRouter, OpenAI)
6. ModelSettings.tsx filters models based on configured API keys
7. Model dropdowns use optgroup to separate providers
</verification>

<success_criteria>
- Store types updated with 'openAI' in ApiKeyProvider union
- Settings slice defaults include empty openAI key
- API key settings UI shows OpenAI field with show/hide toggle
- Model settings filters available models by configured provider
- Model dropdowns group options by provider (OpenAI / OpenRouter)
- Build succeeds with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-openai-provider-support/08-02-SUMMARY.md`
</output>
