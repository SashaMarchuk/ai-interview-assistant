---
phase: 06-prompts-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/types.ts
  - src/store/chromeStorage.ts
  - src/store/settingsSlice.ts
  - src/store/templatesSlice.ts
  - src/store/defaultTemplates.ts
  - src/store/index.ts
  - src/utils/promptSubstitution.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Zustand store persists to chrome.storage.local"
    - "Settings include API keys, models, blur level, hotkeys"
    - "Templates include System Design, Coding, Behavioral defaults"
    - "Store syncs across extension contexts"
  artifacts:
    - path: "src/store/index.ts"
      provides: "Combined store with useStore hook and storeReadyPromise"
      exports: ["useStore", "storeReadyPromise", "StoreState"]
    - path: "src/store/types.ts"
      provides: "TypeScript interfaces for settings and templates"
      exports: ["SettingsSlice", "TemplatesSlice", "PromptTemplate"]
    - path: "src/store/chromeStorage.ts"
      provides: "StateStorage adapter for chrome.storage.local"
      exports: ["chromeStorage"]
    - path: "src/store/defaultTemplates.ts"
      provides: "Default prompt templates for first install"
      exports: ["DEFAULT_TEMPLATES"]
    - path: "src/utils/promptSubstitution.ts"
      provides: "Variable substitution for prompts"
      exports: ["substituteVariables", "PromptVariables"]
  key_links:
    - from: "src/store/index.ts"
      to: "chrome.storage.local"
      via: "chromeStorage StateStorage adapter"
      pattern: "persist.*chromeStorage"
    - from: "src/store/index.ts"
      to: "webext-zustand"
      via: "wrapStore for cross-context sync"
      pattern: "wrapStore"
---

<objective>
Create the Zustand store foundation with settings slice, templates slice, and chrome.storage persistence.

Purpose: Enable all settings and prompt template data to persist and sync across popup, content script, and service worker contexts. This is the data layer that all Phase 6 UI components will consume.

Output: Working Zustand store with types, slices, persistence adapter, default templates, and cross-context sync ready.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-prompts-settings/06-RESEARCH.md

# Existing code
@entrypoints/popup/main.tsx
@entrypoints/popup/App.tsx
@src/types/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create store types</name>
  <files>
    package.json
    src/store/types.ts
  </files>
  <action>
1. Install zustand and webext-zustand:
   ```bash
   npm install zustand webext-zustand
   ```

2. Create `src/store/types.ts` with TypeScript interfaces:

   - `PromptTemplate` interface with:
     - id: string (use crypto.randomUUID())
     - name: string
     - type: 'system-design' | 'coding' | 'behavioral' | 'custom'
     - systemPrompt: string
     - userPromptTemplate: string (contains $variables)
     - modelOverride?: string (optional per-template model)
     - isDefault: boolean

   - `SettingsSlice` interface with:
     - apiKeys: { elevenLabs: string; openRouter: string }
     - models: { fastModel: string; fullModel: string }
     - blurLevel: number (0-20, default 8)
     - hotkeys: { capture: string } (default 'Ctrl+Shift+Space')
     - setApiKey(provider, key): void
     - setModel(type, model): void
     - setBlurLevel(level): void
     - setHotkey(action, binding): void

   - `TemplatesSlice` interface with:
     - templates: PromptTemplate[]
     - activeTemplateId: string | null
     - addTemplate(template): void
     - updateTemplate(id, updates): void
     - deleteTemplate(id): void
     - setActiveTemplate(id): void
     - seedDefaultTemplates(): void

   - `StoreState` type combining both slices
  </action>
  <verify>
    - Run `npm ls zustand webext-zustand` shows both installed
    - `src/store/types.ts` exists and has no TypeScript errors
    - Run `npx tsc --noEmit` passes
  </verify>
  <done>
    Dependencies installed, type definitions complete with SettingsSlice, TemplatesSlice, and PromptTemplate interfaces exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create storage adapter and slices</name>
  <files>
    src/store/chromeStorage.ts
    src/store/settingsSlice.ts
    src/store/templatesSlice.ts
    src/store/defaultTemplates.ts
    src/utils/promptSubstitution.ts
  </files>
  <action>
1. Create `src/store/chromeStorage.ts`:
   - Implement StateStorage interface for zustand/middleware
   - getItem: async get from chrome.storage.local, return null if not found
   - setItem: async set to chrome.storage.local
   - removeItem: async remove from chrome.storage.local

2. Create `src/store/defaultTemplates.ts`:
   - Export DEFAULT_TEMPLATES array with 3 templates:
     - System Design: Focus on scalability, reliability, maintainability
     - Coding: Clean code, edge cases, complexity analysis
     - Behavioral: STAR method structure
   - Each template has userPromptTemplate with $highlighted, $recent variables
   - Use crypto.randomUUID() for IDs (NOT uuid library - avoid extra dependency)
   - isDefault: true for all three

3. Create `src/store/settingsSlice.ts`:
   - Use StateCreator from zustand
   - Default values:
     - apiKeys: { elevenLabs: '', openRouter: '' }
     - models: { fastModel: 'google/gemini-flash-1.5', fullModel: 'anthropic/claude-3-haiku' }
     - blurLevel: 8
     - hotkeys: { capture: 'Ctrl+Shift+Space' }
   - Implement setters that use set() to update state immutably
   - setBlurLevel clamps value to 0-20 range

4. Create `src/store/templatesSlice.ts`:
   - Use StateCreator from zustand
   - Default: templates: [], activeTemplateId: null
   - addTemplate: generates ID with crypto.randomUUID(), adds to array
   - updateTemplate: finds by ID, merges updates
   - deleteTemplate: filters out by ID, clears activeTemplateId if it was deleted
   - setActiveTemplate: sets activeTemplateId
   - seedDefaultTemplates: only seeds if templates array is empty, also sets first as active

5. Create `src/utils/promptSubstitution.ts`:
   - Export PromptVariables interface: { highlighted?: string; recent?: string; transcript?: string; [key: string]: string | undefined }
   - Export substituteVariables function: replaces $variableName with value from variables object
   - If variable not found in object, keep original $variable text (don't crash)
   - Use regex: /\$(\w+)/g
  </action>
  <verify>
    - All files exist in src/store/ and src/utils/
    - Run `npx tsc --noEmit` passes with no errors
    - DEFAULT_TEMPLATES has exactly 3 templates with type 'system-design', 'coding', 'behavioral'
  </verify>
  <done>
    Chrome storage adapter, settings slice, templates slice, default templates, and prompt substitution utility all created with TypeScript types.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create combined store with persistence and cross-context sync</name>
  <files>
    src/store/index.ts
  </files>
  <action>
1. Create `src/store/index.ts`:

2. Import dependencies:
   - create from 'zustand'
   - persist, createJSONStorage from 'zustand/middleware'
   - wrapStore from 'webext-zustand'
   - All slices and chromeStorage

3. Create the combined store:
   - Use create<StoreState>()
   - Wrap with persist() middleware
   - Combine slices: ...createSettingsSlice(...a), ...createTemplatesSlice(...a)
   - Configure persist:
     - name: 'ai-interview-settings'
     - storage: createJSONStorage(() => chromeStorage)
     - partialize: only persist apiKeys, models, blurLevel, hotkeys, templates, activeTemplateId
     - onRehydrateStorage: return callback that calls seedDefaultTemplates() after rehydration if templates empty

4. Export storeReadyPromise from wrapStore(useStore):
   - This enables cross-context state synchronization
   - Popup/content script will await this before rendering

5. Re-export StoreState type for consumers
  </action>
  <verify>
    - `src/store/index.ts` exports useStore, storeReadyPromise, and StoreState
    - Run `npx tsc --noEmit` passes
    - Run `npm run build` completes without errors
  </verify>
  <done>
    Combined Zustand store created with chrome.storage persistence, cross-context sync via webext-zustand, and automatic default template seeding on first install.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Type check passes:
   ```bash
   npx tsc --noEmit
   ```

2. Build succeeds:
   ```bash
   npm run build
   ```

3. Store structure is correct:
   - src/store/index.ts exports useStore, storeReadyPromise
   - src/store/types.ts exports all interfaces
   - src/store/chromeStorage.ts exports chromeStorage
   - src/store/defaultTemplates.ts exports DEFAULT_TEMPLATES (3 templates)
   - src/utils/promptSubstitution.ts exports substituteVariables

4. Manual verification in popup:
   - Extension can still load (no runtime errors)
   - Console shows no import errors
</verification>

<success_criteria>
1. `npm ls zustand webext-zustand` shows both packages installed
2. `npx tsc --noEmit` passes with zero errors
3. `npm run build` completes successfully
4. Store files exist: src/store/{index,types,chromeStorage,settingsSlice,templatesSlice,defaultTemplates}.ts
5. Utility exists: src/utils/promptSubstitution.ts
6. DEFAULT_TEMPLATES array has 3 templates (system-design, coding, behavioral)
</success_criteria>

<output>
After completion, create `.planning/phases/06-prompts-settings/06-01-SUMMARY.md`
</output>
