---
phase: 18-cost-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/components/cost/CostDashboard.tsx
  - src/components/cost/DailyCostChart.tsx
  - src/components/cost/ProviderBreakdown.tsx
  - src/components/cost/SessionCostList.tsx
  - entrypoints/popup/App.tsx
autonomous: true

must_haves:
  truths:
    - "Opening the popup shows a 'Cost' tab alongside Capture, Settings, and Templates"
    - "Clicking the Cost tab displays a dashboard with a daily cost bar chart, provider/model breakdown pie chart, and session cost list"
    - "Charts render correctly using recharts at the popup's 384px width with no overflow or overlapping labels"
    - "The dashboard loads data from IndexedDB on mount and shows a loading state while fetching"
    - "A date range filter (7d / 30d / 90d) controls which records are displayed"
    - "A 'Clear History' button deletes all cost records from IndexedDB"
    - "Records older than 90 days are automatically pruned on dashboard mount"
  artifacts:
    - path: "src/components/cost/CostDashboard.tsx"
      provides: "Main cost dashboard with date filter, auto-pruning, and lazy-loaded chart layout"
      contains: "CostDashboard"
    - path: "src/components/cost/DailyCostChart.tsx"
      provides: "BarChart showing daily cost totals"
      contains: "recharts"
    - path: "src/components/cost/ProviderBreakdown.tsx"
      provides: "PieChart showing cost by provider and model"
      contains: "PieChart"
    - path: "src/components/cost/SessionCostList.tsx"
      provides: "List of per-session cost summaries"
      contains: "SessionSummary"
    - path: "entrypoints/popup/App.tsx"
      provides: "Cost tab in popup navigation, lazy-loaded CostDashboard"
      contains: "cost"
  key_links:
    - from: "src/components/cost/CostDashboard.tsx"
      to: "src/services/costHistory/costDb.ts"
      via: "getCostRecordsSince() and deleteRecordsBefore() calls in useEffect"
      pattern: "getCostRecordsSince"
    - from: "src/components/cost/CostDashboard.tsx"
      to: "src/services/costHistory/aggregation.ts"
      via: "aggregateByDay, aggregateByProvider, aggregateByModel, aggregateBySessions"
      pattern: "aggregateBy"
    - from: "entrypoints/popup/App.tsx"
      to: "src/components/cost/CostDashboard.tsx"
      via: "React.lazy() dynamic import"
      pattern: "lazy.*CostDashboard"
---

<objective>
Build the cost dashboard UI with recharts charts and integrate it as a new "Cost" tab in the popup.

Purpose: Cost records are being persisted to IndexedDB (Plan 01). Now the user needs to see their historical cost data visualized with charts showing daily spending, provider/model breakdown, and per-session costs. This completes the COST-04 and COST-05 requirements.

Output: Four React components (CostDashboard, DailyCostChart, ProviderBreakdown, SessionCostList) and an updated popup App.tsx with the Cost tab.
</objective>

<execution_context>
@/Users/sasha-marchuk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sasha-marchuk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cost-dashboard/18-RESEARCH.md
@.planning/phases/18-cost-dashboard/18-01-SUMMARY.md
@entrypoints/popup/App.tsx
@src/services/costHistory/costDb.ts
@src/services/costHistory/types.ts
@src/services/costHistory/aggregation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install recharts and create chart components</name>
  <files>
    src/components/cost/DailyCostChart.tsx
    src/components/cost/ProviderBreakdown.tsx
    src/components/cost/SessionCostList.tsx
  </files>
  <action>
**Step 1: Install recharts**
Run `npm install recharts` to add the SVG-based charting library.

**Step 2: Create chart components** in `src/components/cost/`:

**DailyCostChart.tsx** - Bar chart for daily cost totals:
- Props: `{ data: DailyCost[] }` (import DailyCost from costHistory/types)
- Use recharts: `ResponsiveContainer` (width="100%", height={180}), `BarChart`, `Bar`, `XAxis`, `YAxis`, `Tooltip`, `CartesianGrid`
- XAxis dataKey="date", tick fontSize 10, angle -45 for narrow popup width
- YAxis tick fontSize 10, tickFormatter: `$X.XX` format
- Tooltip formatter: `$X.XXXX` format for precision
- Bar fill="#3B82F6" (Tailwind blue-500), radius [4,4,0,0]
- CartesianGrid strokeDasharray="3 3"
- If data is empty, show a centered text: "No cost data yet"
- Wrap `ResponsiveContainer` in a div with explicit `h-[180px]` to prevent Pitfall 3 (zero-height collapse)

**ProviderBreakdown.tsx** - Pie chart for provider/model cost distribution:
- Props: `{ providerData: ProviderCost[]; modelData: ModelCost[] }` (import from costHistory/types)
- Show two sections: "By Provider" (pie chart) and "By Model" (simple list with color dots)
- Use recharts: `ResponsiveContainer` (width="100%", height={180}), `PieChart`, `Pie`, `Cell`, `Tooltip`, `Legend`
- COLORS array: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'] for up to 5 segments
- Pie: dataKey="value", nameKey="name", cx="50%", cy="50%", outerRadius={60}, label={false} (labels overlap at 384px, use legend instead)
- Tooltip formatter: `$X.XXXX` format
- Legend: wrapperStyle fontSize 11
- For "By Model" section: simple div list showing top 5 models with colored dots and cost amounts
- If providerData is empty, show "No cost data yet"

**SessionCostList.tsx** - Scrollable list of per-session cost summaries:
- Props: `{ sessions: SessionSummary[] }` (import from costHistory/types)
- Render as a scrollable list (max-h-[200px] overflow-y-auto)
- Each session row shows: formatted date/time (Intl.DateTimeFormat), request count, total cost ($X.XXXX), total tokens
- If sessions is empty, show "No sessions recorded"
- Style with Tailwind: divide-y, text-sm, alternating bg-gray-50 rows for readability
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all chart components compile. Verify recharts is in package.json dependencies.
  </verify>
  <done>
Three chart components created: DailyCostChart (bar chart), ProviderBreakdown (pie chart + model list), SessionCostList (scrollable list). All use recharts for SVG rendering. Designed for 384px popup width.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CostDashboard and add Cost tab to popup</name>
  <files>
    src/components/cost/CostDashboard.tsx
    entrypoints/popup/App.tsx
  </files>
  <action>
**CostDashboard.tsx** - Main dashboard component that orchestrates data loading and chart rendering:

1. **State:**
   - `records: CostRecord[]` - raw records from IndexedDB
   - `loading: boolean` - true while fetching
   - `dateRange: 7 | 30 | 90` - filter range in days (default 30)

2. **Data loading (useEffect on mount + dateRange change):**
   - Set loading=true
   - Call `getCostRecordsSince(Date.now() - dateRange * 24 * 60 * 60 * 1000)`
   - Set records + loading=false
   - Also run auto-pruning on mount only: `deleteRecordsBefore(Date.now() - 90 * 24 * 60 * 60 * 1000)` (silent, fire-and-forget)

3. **Aggregation (useMemo from records):**
   - `dailyData = aggregateByDay(records)`
   - `providerData = aggregateByProvider(records)`
   - `modelData = aggregateByModel(records)`
   - `sessionData = aggregateBySessions(records)`
   - `totalCost = records.reduce((sum, r) => sum + r.costUSD, 0)`
   - `totalTokens = records.reduce((sum, r) => sum + r.totalTokens, 0)`

4. **Layout:**
   - Header: "Cost Dashboard" with total cost and total tokens summary
   - Date range filter: three buttons (7d, 30d, 90d) styled as pill buttons, active state with bg-blue-600 text-white
   - Chart sections with h3 headings: "Daily Costs", "Provider & Model Breakdown", "Sessions"
   - Each section separated by dividers
   - "Clear History" button at bottom: calls `clearAllRecords()` then reloads data. Use window.confirm() before clearing.
   - Loading state: show "Loading cost data..." centered text

5. **Styling:** Tailwind classes consistent with existing popup sections (space-y-4, text-sm, rounded-lg borders)

**App.tsx modifications:**

1. **Add lazy import** at top of file (after other imports):
   ```typescript
   import { lazy, Suspense } from 'react';
   const CostDashboard = lazy(() => import('../../src/components/cost/CostDashboard'));
   ```
   Note: `useState` and `useEffect` are already imported from 'react'. Add `lazy` and `Suspense` to the existing import.

2. **Expand Tab type** from `'capture' | 'settings' | 'templates'` to `'capture' | 'settings' | 'templates' | 'cost'`

3. **Add 'cost' to tab navigation array** - Change `(['capture', 'settings', 'templates'] as const)` to `(['capture', 'settings', 'templates', 'cost'] as const)`

4. **Add Cost tab content** - After the templates tab content block, add:
   ```tsx
   {activeTab === 'cost' && (
     <Suspense fallback={<div className="p-4 text-center text-sm text-gray-500">Loading cost data...</div>}>
       <CostDashboard />
     </Suspense>
   )}
   ```

5. **CostDashboard must be a default export** so React.lazy() can import it.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all files compile. Run `npx eslint .` to check for linting errors. Run `npm run dev` and verify the extension builds without errors.
  </verify>
  <done>
CostDashboard component loads data from IndexedDB, aggregates it, and renders three chart sections. Popup App.tsx has a "Cost" tab that lazy-loads the dashboard. Charts render at 384px popup width. Auto-pruning of 90-day-old records runs on mount. Clear History button available.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx eslint .` passes with zero errors
3. `npm run dev` builds successfully
4. recharts is listed in package.json dependencies
5. New files exist: `src/components/cost/CostDashboard.tsx`, `DailyCostChart.tsx`, `ProviderBreakdown.tsx`, `SessionCostList.tsx`
6. Popup App.tsx has 4 tabs: capture, settings, templates, cost
7. CostDashboard is lazy-loaded via React.lazy()
</verification>

<success_criteria>
- Popup shows 4 tabs including "Cost"
- Cost tab lazy-loads CostDashboard with recharts bundle
- Dashboard shows daily cost bar chart, provider pie chart, model breakdown, and session list
- Date range filter (7d/30d/90d) controls displayed data
- Auto-pruning removes records older than 90 days
- Clear History button wipes all IndexedDB cost data
- Charts render correctly at 384px popup width without overflow
</success_criteria>

<output>
After completion, create `.planning/phases/18-cost-dashboard/18-02-SUMMARY.md`
</output>
